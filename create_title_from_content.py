#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Создание заголовка на основе контента статьи через DeepSeek
"""

import os
import requests
import json

DEEPSEEK_API_KEY = os.getenv('DEEPSEEK_API_KEY')

def создать_заголовок_на_основе_контента(контент: str, оригинальный_заголовок: str = '') -> str:
    """
    Создаёт заголовок на русском языке на основе контента статьи через DeepSeek
    
    ✅ ИСПРАВЛЕНИЕ: Заголовок создаётся на основе контента, а не жестко закодированных вариантов
    """
    if not DEEPSEEK_API_KEY:
        print("⚠️ DEEPSEEK_API_KEY не настроен, используем оригинальный заголовок")
        return оригинальный_заголовок or 'Статья о фитнесе'
    
    try:
        url = "https://api.deepseek.com/v1/chat/completions"
        
        headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {DEEPSEEK_API_KEY}"
        }
        
        # Берём первые 2000 символов контента для анализа
        контент_для_анализа = контент[:2000] if len(контент) > 2000 else контент
        
        system_prompt = """Ты эксперт по созданию заголовков для фитнес-статей на русском языке.

Твоя задача - создать точный, привлекательный заголовок на русском языке на основе контента статьи.

ПРАВИЛА:
1. Заголовок должен точно отражать содержание статьи
2. Заголовок должен быть на русском языке
3. Заголовок должен быть привлекательным, но не рекламным
4. Если статья для девушек/женщин - используй соответствующий стиль
5. Если статья для мужчин - используй соответствующий стиль
6. Заголовок должен быть 5-12 слов
7. НЕ используй общие фразы типа "Полезная статья о фитнесе"
8. НЕ используй мужские заголовки для женского контента
9. НЕ используй женские заголовки для мужского контента

Верни ТОЛЬКО заголовок, без кавычек, без дополнительных объяснений."""
        
        user_prompt = f"""Создай точный заголовок на русском языке для этой статьи:

ОРИГИНАЛЬНЫЙ ЗАГОЛОВОК (для справки): {оригинальный_заголовок}

КОНТЕНТ СТАТЬИ:
{контент_для_анализа}

Создай заголовок на русском языке, который точно отражает содержание статьи."""
        
        data = {
            "model": "deepseek-chat",
            "messages": [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            "temperature": 0.7,
            "max_tokens": 100
        }
        
        response = requests.post(url, headers=headers, json=data, timeout=30)
        response.raise_for_status()
        
        result = response.json()
        заголовок = result['choices'][0]['message']['content'].strip()
        
        # Убираем кавычки если есть
        заголовок = заголовок.strip('"\'«»')
        
        # Убираем технические признаки
        import re
        заголовок = re.sub(r'podcast\s*#?\s*\d+[,:]?\s*', '', заголовок, flags=re.IGNORECASE)
        заголовок = re.sub(r'episode\s*#?\s*\d+[,:]?\s*', '', заголовок, flags=re.IGNORECASE)
        заголовок = re.sub(r'#\s*\d+[,:]?\s*', '', заголовок)
        заголовок = заголовок.strip(' -—:')
        
        return заголовок
    
    except Exception as e:
        print(f"⚠️ Ошибка создания заголовка через DeepSeek: {e}")
        # Fallback: возвращаем оригинальный заголовок
        return оригинальный_заголовок or 'Статья о фитнесе'
