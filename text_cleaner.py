#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Модуль для очистки текстов от AI-маркеров
Удаляет звёздочки, хештеги, маркдаун-синтаксис и другие признаки AI-контента
"""

import re

def очистить_текст_от_ai_маркеров(текст: str) -> str:
    """
    Очищает текст от AI-маркеров, делая его более естественным
    
    Args:
        текст: Текст для очистки
    
    Returns:
        Очищенный текст
    """
    if not текст:
        return текст
    
    # КРИТИЧЕСКИ ВАЖНО: Удаляем ВСЕ звёздочки для выделения (***, **, *)
    # Сначала удаляем тройные и более звёздочки
    текст = re.sub(r'\*{3,}', '', текст)  # Удаляем *** и более
    # Затем удаляем двойные звёздочки **текст**
    текст = re.sub(r'\*\*([^*]+)\*\*', r'\1', текст)
    # Затем удаляем одиночные звёздочки *текст*
    текст = re.sub(r'\*([^*\n]+)\*', r'\1', текст)
    # Удаляем оставшиеся одиночные звёздочки в начале/конце строк
    текст = re.sub(r'^\*+|\*+$', '', текст, flags=re.MULTILINE)
    
    # Удаляем хештеги в тексте (но не в конце как отдельные строки)
    # Удаляем только если хештег внутри предложения
    текст = re.sub(r'#(\w+)', r'\1', текст)
    
    # КРИТИЧЕСКИ ВАЖНО: Удаляем ВСЕ маркдаун-заголовки (##, ###, ####)
    текст = re.sub(r'^#{1,6}\s+', '', текст, flags=re.MULTILINE)
    # Удаляем хештеги в начале строки
    текст = re.sub(r'^#+\s*', '', текст, flags=re.MULTILINE)
    
    # Удаляем подчёркивания для выделения (__текст__, _текст_)
    текст = re.sub(r'__([^_]+)__', r'\1', текст)
    текст = re.sub(r'_([^_]+)_', r'\1', текст)
    
    # Удаляем маркдаун-списки с маркерами (но сохраняем содержимое)
    # Заменяем "- " на обычный текст
    текст = re.sub(r'^[-*+]\s+', '', текст, flags=re.MULTILINE)
    
    # Удаляем лишние переносы строк (более 2 подряд)
    текст = re.sub(r'\n{3,}', '\n\n', текст)
    
    # Удаляем лишние пробелы
    текст = re.sub(r' {2,}', ' ', текст)
    
    # Удаляем разделители из звёздочек (---, ***)
    текст = re.sub(r'^[-*]{3,}$', '', текст, flags=re.MULTILINE)
    
    return текст.strip()

def очистить_текст_для_telegram(текст: str) -> str:
    """
    Очищает текст для Telegram (более агрессивная очистка)
    
    Args:
        текст: Текст для очистки
    
    Returns:
        Очищенный текст
    """
    текст = очистить_текст_от_ai_маркеров(текст)
    
    # Дополнительная очистка для Telegram
    # Удаляем все хештеги в конце (если они есть)
    текст = re.sub(r'\n+#\w+(\s+#\w+)*$', '', текст, flags=re.MULTILINE)
    
    return текст.strip()

def очистить_текст_для_статьи(текст: str) -> str:
    """
    Очищает текст для статьи на сайте
    
    Args:
        текст: Текст для очистки
    
    Returns:
        Очищенный текст
    """
    текст = очистить_текст_от_ai_маркеров(текст)
    
    # Для статей можно оставить структуру, но убрать маркдаун
    # Заменяем маркдаун-заголовки на обычный текст
    текст = re.sub(r'^#{1,6}\s+(.+)$', r'\1', текст, flags=re.MULTILINE)
    
    return текст.strip()
