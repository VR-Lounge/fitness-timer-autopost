#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Модуль для очистки текстов от AI-маркеров
Удаляет звёздочки, хештеги, маркдаун-синтаксис и другие признаки AI-контента
"""

import re

# Маркеры рекламного/брендированного контента
РЕКЛАМНЫЕ_МАРКЕРЫ = [
    # бренды
    r'\badidas\b', r'\bnike\b', r'\bpuma\b', r'\breebok\b', r'\basics\b',
    r'\bunder\s*armour\b', r'\bunder\s*armor\b', r'\bnew\s*balance\b',
    r'\bgymshark\b', r'\blululemon\b',
    # маркетинговые слова
    r'промо', r'промокод', r'скидк', r'акци', r'распродаж', r'куп(и|ить|лю)',
    r'закаж(и|ите)', r'цена', r'стоимост', r'доставка', r'магазин', r'бренд',
    r'новинк', r'коллекци', r'линейк', r'серия', r'партнер',
    r'официальн', r'ссылка', r'подписк', r'реклама'
]

def очистить_текст_от_ai_маркеров(текст: str) -> str:
    """
    Очищает текст от AI-маркеров, делая его более естественным
    
    Args:
        текст: Текст для очистки
    
    Returns:
        Очищенный текст
    """
    if not текст:
        return текст
    
    # КРИТИЧЕСКИ ВАЖНО: Удаляем ВСЕ звёздочки для выделения (***, **, *)
    # Сначала удаляем тройные и более звёздочки
    текст = re.sub(r'\*{3,}', '', текст)  # Удаляем *** и более
    # Затем удаляем двойные звёздочки **текст**
    текст = re.sub(r'\*\*([^*]+)\*\*', r'\1', текст)
    # Затем удаляем одиночные звёздочки *текст*
    текст = re.sub(r'\*([^*\n]+)\*', r'\1', текст)
    # Удаляем оставшиеся одиночные звёздочки в начале/конце строк
    текст = re.sub(r'^\*+|\*+$', '', текст, flags=re.MULTILINE)
    
    # Удаляем хештеги в тексте (но не в конце как отдельные строки)
    # Удаляем только если хештег внутри предложения
    текст = re.sub(r'#(\w+)', r'\1', текст)
    
    # КРИТИЧЕСКИ ВАЖНО: Удаляем ВСЕ маркдаун-заголовки (##, ###, ####)
    текст = re.sub(r'^#{1,6}\s+', '', текст, flags=re.MULTILINE)
    # Удаляем хештеги в начале строки
    текст = re.sub(r'^#+\s*', '', текст, flags=re.MULTILINE)
    
    # Удаляем подчёркивания для выделения (__текст__, _текст_)
    текст = re.sub(r'__([^_]+)__', r'\1', текст)
    текст = re.sub(r'_([^_]+)_', r'\1', текст)
    
    # Удаляем маркдаун-списки с маркерами (но сохраняем содержимое)
    # Заменяем "- " на обычный текст
    текст = re.sub(r'^[-*+]\s+', '', текст, flags=re.MULTILINE)
    
    # Удаляем лишние переносы строк (более 2 подряд)
    текст = re.sub(r'\n{3,}', '\n\n', текст)
    
    # Удаляем лишние пробелы
    текст = re.sub(r' {2,}', ' ', текст)
    
    # Удаляем разделители из звёздочек (---, ***)
    текст = re.sub(r'^[-*]{3,}$', '', текст, flags=re.MULTILINE)
    
    return текст.strip()

def очистить_текст_для_telegram(текст: str) -> str:
    """
    Очищает текст для Telegram (более агрессивная очистка)
    
    Args:
        текст: Текст для очистки
    
    Returns:
        Очищенный текст
    """
    текст = очистить_текст_от_ai_маркеров(текст)
    
    # Дополнительная очистка для Telegram
    # Удаляем все хештеги в конце (если они есть)
    текст = re.sub(r'\n+#\w+(\s+#\w+)*$', '', текст, flags=re.MULTILINE)
    
    return текст.strip()

def очистить_текст_для_статьи(текст: str) -> str:
    """
    Очищает текст для статьи на сайте
    
    Args:
        текст: Текст для очистки
    
    Returns:
        Очищенный текст
    """
    текст = очистить_текст_от_ai_маркеров(текст)
    
    # Для статей можно оставить структуру, но убрать маркдаун
    # Заменяем маркдаун-заголовки на обычный текст
    текст = re.sub(r'^#{1,6}\s+(.+)$', r'\1', текст, flags=re.MULTILINE)
    
    return текст.strip()

def содержит_рекламные_маркеры(текст: str) -> bool:
    """Проверяет, содержит ли текст рекламные/брендовые маркеры."""
    if not текст:
        return False
    lower_text = текст.lower()
    for pattern in РЕКЛАМНЫЕ_МАРКЕРЫ:
        if re.search(pattern, lower_text):
            return True
    return False
