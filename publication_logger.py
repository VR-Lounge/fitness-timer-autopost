#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
    –ú–æ–¥—É–ª—å –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∫–∞–∂–¥–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–∞–ª–∞–Ω—Å–∞ —Ç–µ–º–∞—Ç–∏–∫,
    –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞.
    
    –ê–≤—Ç–æ—Ä: VR-Lounge
"""

import json
import os
from pathlib import Path
from datetime import datetime
from typing import Dict, Optional

# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –ª–æ–≥–æ–≤
PUBLICATION_LOG_FILE = Path('.publication_logs.json')

def –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å_–ø—É–±–ª–∏–∫–∞—Ü–∏—é(–¥–∞–Ω–Ω—ã–µ: Dict):
    """
    –õ–æ–≥–∏—Ä—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
    
    Args:
        –¥–∞–Ω–Ω—ã–µ: –°–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:
            - date: –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (ISO format)
            - time: –í—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (UTC)
            - audience: –ê—É–¥–∏—Ç–æ—Ä–∏—è (–î–µ–≤—É—à–∫–∞–º/–ú—É–∂—á–∏–Ω–∞–º)
            - tags: –°–ø–∏—Å–æ–∫ —Ç–µ–≥–æ–≤
            - source_rss: URL RSS —Ñ–∏–¥–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
            - publish_to_blog: –ü—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –ª–∏ –Ω–∞ —Å–∞–π—Ç
            - publish_to_telegram: –ü—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –ª–∏ –≤ Telegram
            - title: –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏
            - post_id: ID –ø–æ—Å—Ç–∞
            - url: URL —Å—Ç–∞—Ç—å–∏ –Ω–∞ —Å–∞–π—Ç–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    """
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ª–æ–≥–∏
        –ª–æ–≥–∏ = []
        if PUBLICATION_LOG_FILE.exists():
            with open(PUBLICATION_LOG_FILE, 'r', encoding='utf-8') as f:
                –ª–æ–≥–∏ = json.load(f)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
        –ª–æ–≥–∏.append(–¥–∞–Ω–Ω—ã–µ)
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä (—Ö—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 –∑–∞–ø–∏—Å–µ–π)
        if len(–ª–æ–≥–∏) > 1000:
            –ª–æ–≥–∏ = –ª–æ–≥–∏[-1000:]
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º
        PUBLICATION_LOG_FILE.parent.mkdir(parents=True, exist_ok=True)
        with open(PUBLICATION_LOG_FILE, 'w', encoding='utf-8') as f:
            json.dump(–ª–æ–≥–∏, f, ensure_ascii=False, indent=2)
        
        print(f"üìù –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∞: {–¥–∞–Ω–Ω—ã–µ.get('title', '')[:50]}...")
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: {e}")

def –ø–æ–ª—É—á–∏—Ç—å_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É_–ø—É–±–ª–∏–∫–∞—Ü–∏–π(–¥–Ω–µ–π: int = 7) -> Dict:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—É–±–ª–∏–∫–∞—Ü–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π
    
    Args:
        –¥–Ω–µ–π: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
    """
    if not PUBLICATION_LOG_FILE.exists():
        return {}
    
    try:
        with open(PUBLICATION_LOG_FILE, 'r', encoding='utf-8') as f:
            –ª–æ–≥–∏ = json.load(f)
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
        —Å–µ–π—á–∞—Å = datetime.now()
        –≥—Ä–∞–Ω–∏—Ü–∞ = —Å–µ–π—á–∞—Å.timestamp() - (–¥–Ω–µ–π * 24 * 60 * 60)
        
        –ª–æ–≥–∏_–∑–∞_–ø–µ—Ä–∏–æ–¥ = []
        for –∑–∞–ø–∏—Å—å in –ª–æ–≥–∏:
            try:
                –¥–∞—Ç–∞_–∑–∞–ø–∏—Å–∏ = datetime.fromisoformat(–∑–∞–ø–∏—Å—å.get('date', '').replace('Z', '+00:00'))
                if –¥–∞—Ç–∞_–∑–∞–ø–∏—Å–∏.timestamp() >= –≥—Ä–∞–Ω–∏—Ü–∞:
                    –ª–æ–≥–∏_–∑–∞_–ø–µ—Ä–∏–æ–¥.append(–∑–∞–ø–∏—Å—å)
            except:
                continue
        
        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        –≤—Å–µ–≥–æ_–ø—É–±–ª–∏–∫–∞—Ü–∏–π = len(–ª–æ–≥–∏_–∑–∞_–ø–µ—Ä–∏–æ–¥)
        –Ω–∞_—Å–∞–π—Ç = sum(1 for –∑ in –ª–æ–≥–∏_–∑–∞_–ø–µ—Ä–∏–æ–¥ if –∑.get('publish_to_blog', False))
        –≤_telegram = sum(1 for –∑ in –ª–æ–≥–∏_–∑–∞_–ø–µ—Ä–∏–æ–¥ if –∑.get('publish_to_telegram', False))
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ–≥–∞–º
        –≤—Å–µ_—Ç–µ–≥–∏ = []
        for –∑–∞–ø–∏—Å—å in –ª–æ–≥–∏_–∑–∞_–ø–µ—Ä–∏–æ–¥:
            —Ç–µ–≥–∏ = –∑–∞–ø–∏—Å—å.get('tags', [])
            –≤—Å–µ_—Ç–µ–≥–∏.extend(—Ç–µ–≥–∏)
        
        from collections import Counter
        —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_—Ç–µ–≥–æ–≤ = dict(Counter(–≤—Å–µ_—Ç–µ–≥–∏))
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞—É–¥–∏—Ç–æ—Ä–∏–∏
        —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_–∞—É–¥–∏—Ç–æ—Ä–∏–∏ = {}
        for –∑–∞–ø–∏—Å—å in –ª–æ–≥–∏_–∑–∞_–ø–µ—Ä–∏–æ–¥:
            –∞—É–¥–∏—Ç–æ—Ä–∏—è = –∑–∞–ø–∏—Å—å.get('audience', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
            —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_–∞—É–¥–∏—Ç–æ—Ä–∏–∏[–∞—É–¥–∏—Ç–æ—Ä–∏—è] = —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_–∞—É–¥–∏—Ç–æ—Ä–∏–∏.get(–∞—É–¥–∏—Ç–æ—Ä–∏—è, 0) + 1
        
        return {
            '–ø–µ—Ä–∏–æ–¥_–¥–Ω–µ–π': –¥–Ω–µ–π,
            '–≤—Å–µ–≥–æ_–ø—É–±–ª–∏–∫–∞—Ü–∏–π': –≤—Å–µ–≥–æ_–ø—É–±–ª–∏–∫–∞—Ü–∏–π,
            '–Ω–∞_—Å–∞–π—Ç': –Ω–∞_—Å–∞–π—Ç,
            '–≤_telegram': –≤_telegram,
            '—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_—Ç–µ–≥–æ–≤': —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_—Ç–µ–≥–æ–≤,
            '—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_–∞—É–¥–∏—Ç–æ—Ä–∏–∏': —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_–∞—É–¥–∏—Ç–æ—Ä–∏–∏,
            '–ª–æ–≥–∏': –ª–æ–≥–∏_–∑–∞_–ø–µ—Ä–∏–æ–¥
        }
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
        return {}

def –ø—Ä–æ–≤–µ—Ä–∏—Ç—å_–¥–∏—Å–±–∞–ª–∞–Ω—Å_—Ç–µ–º–∞—Ç–∏–∫(–¥–Ω–µ–π: int = 7) -> Optional[Dict]:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞ —Ç–µ–º–∞—Ç–∏–∫ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    
    Args:
        –¥–Ω–µ–π: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –æ –¥–∏—Å–±–∞–ª–∞–Ω—Å–µ –∏–ª–∏ None
    """
    —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ = –ø–æ–ª—É—á–∏—Ç—å_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É_–ø—É–±–ª–∏–∫–∞—Ü–∏–π(–¥–Ω–µ–π)
    
    if not —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ or —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.get('–≤—Å–µ–≥–æ_–ø—É–±–ª–∏–∫–∞—Ü–∏–π', 0) < 5:
        return None
    
    # –¶–µ–ª–µ–≤–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
    —Ü–µ–ª–µ–≤–æ–µ = {
        '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞': 40,
        '–ü–∏—Ç–∞–Ω–∏–µ': 30,
        '–î–∏–µ—Ç—ã': 15,
        '–ú–æ—Ç–∏–≤–∞—Ü–∏—è': 15
    }
    
    —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_—Ç–µ–≥–æ–≤ = —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.get('—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_—Ç–µ–≥–æ–≤', {})
    –≤—Å–µ–≥–æ = —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.get('–≤—Å–µ–≥–æ_–ø—É–±–ª–∏–∫–∞—Ü–∏–π', 1)
    
    –¥–∏—Å–±–∞–ª–∞–Ω—Å—ã = []
    for —Ç–µ–º–∞, —Ü–µ–ª–µ–≤–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç in —Ü–µ–ª–µ–≤—ã–º.items():
        —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ_–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ = —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_—Ç–µ–≥–æ–≤.get(—Ç–µ–º–∞, 0)
        —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π_–ø—Ä–æ—Ü–µ–Ω—Ç = (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ_–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ / –≤—Å–µ–≥–æ) * 100
        
        –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ = abs(—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π_–ø—Ä–æ—Ü–µ–Ω—Ç - —Ü–µ–ª–µ–≤–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç)
        
        if –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ > 15:  # –ï—Å–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –±–æ–ª—å—à–µ 15%
            –¥–∏—Å–±–∞–ª–∞–Ω—Å—ã.append({
                '—Ç–µ–º–∞': —Ç–µ–º–∞,
                '—Ü–µ–ª–µ–≤–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç': —Ü–µ–ª–µ–≤–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç,
                '—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π_–ø—Ä–æ—Ü–µ–Ω—Ç': —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π_–ø—Ä–æ—Ü–µ–Ω—Ç,
                '–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ': –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
            })
    
    if –¥–∏—Å–±–∞–ª–∞–Ω—Å—ã:
        return {
            '—Ç–∏–ø': '–¥–∏—Å–±–∞–ª–∞–Ω—Å_—Ç–µ–º–∞—Ç–∏–∫',
            '–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ': f'–û–±–Ω–∞—Ä—É–∂–µ–Ω –¥–∏—Å–±–∞–ª–∞–Ω—Å —Ç–µ–º–∞—Ç–∏–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {–¥–Ω–µ–π} –¥–Ω–µ–π',
            '–¥–∏—Å–±–∞–ª–∞–Ω—Å—ã': –¥–∏—Å–±–∞–ª–∞–Ω—Å—ã,
            '—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è': '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±–æ—Ä —Å—Ç–∞—Ç–µ–π –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏'
        }
    
    return None
