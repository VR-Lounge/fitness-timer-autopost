name: üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

on:
  schedule:
    # –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è 2000 –º–∏–Ω/–º–µ—Å—è—Ü)
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  auto-reply:
    name: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –æ—Ç–≤–µ—Ç—ã
    runs-on: ubuntu-latest
    
    steps:
      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # –ö—ç—à–∏—Ä—É–µ–º pip –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
      
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è (cache)
        uses: actions/cache@v4
        id: cache-state
        with:
          path: |
            .auto_reply_state.json
            .answered_messages.json
          key: auto-reply-state-${{ github.repository }}-v1
          restore-keys: |
            auto-reply-state-${{ github.repository }}-v1
            auto-reply-state-${{ github.repository }}-
      
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ cache..."
          if [ -f ".auto_reply_state.json" ]; then
            echo "‚úÖ –§–∞–π–ª .auto_reply_state.json –Ω–∞–π–¥–µ–Ω"
            cat .auto_reply_state.json
          else
            echo "‚ö†Ô∏è –§–∞–π–ª .auto_reply_state.json –Ω–µ –Ω–∞–π–¥–µ–Ω (cache –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫)"
          fi
          if [ -f ".answered_messages.json" ]; then
            echo "‚úÖ –§–∞–π–ª .answered_messages.json –Ω–∞–π–¥–µ–Ω"
          else
            echo "‚ö†Ô∏è –§–∞–π–ª .answered_messages.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
          fi
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          pip install --upgrade pip --quiet
          pip install requests --quiet
          # –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ email –æ—Ç—á—ë—Ç–æ–≤ (–≤—Å—Ç—Ä–æ–µ–Ω–æ –≤ Python, –Ω–æ —É–±–µ–¥–∏–º—Å—è)
          python -c "import smtplib; import email" || echo "Email –º–æ–¥—É–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã"
      
      - name: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ADMIN_TELEGRAM_CHAT_ID: ${{ secrets.ADMIN_TELEGRAM_CHAT_ID }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        run: |
          python auto_reply.py
      
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
        if: always()
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ cache..."
          if [ -f ".auto_reply_state.json" ]; then
            echo "‚úÖ –§–∞–π–ª .auto_reply_state.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            echo "üìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
            cat .auto_reply_state.json
          else
            echo "‚ùå –§–∞–π–ª .auto_reply_state.json –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
          fi
          if [ -f ".answered_messages.json" ]; then
            echo "‚úÖ –§–∞–π–ª .answered_messages.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            echo "üìä –†–∞–∑–º–µ—Ä: $(wc -l < .answered_messages.json) —Å—Ç—Ä–æ–∫"
          else
            echo "‚ö†Ô∏è –§–∞–π–ª .answered_messages.json –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          fi
      
      - name: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (cache)
        uses: actions/cache@v4
        if: always()
        with:
          path: |
            .auto_reply_state.json
            .answered_messages.json
          key: auto-reply-state-${{ github.repository }}-v1
          restore-keys: |
            auto-reply-state-${{ github.repository }}-v1
            auto-reply-state-${{ github.repository }}-

