name: üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

on:
  schedule:
    # –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è 2000 –º–∏–Ω/–º–µ—Å—è—Ü)
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  auto-reply:
    name: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –æ—Ç–≤–µ—Ç—ã
    runs-on: ubuntu-latest
    
    steps:
      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # –ö—ç—à–∏—Ä—É–µ–º pip –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
      
      - name: –ü–æ–ª—É—á–µ–Ω–∏–µ ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        id: get-last-run
        run: |
          echo "üîç –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—É—Å–∫ workflow..."
          WORKFLOW_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/auto-reply.yml" | \
            jq -r '.id')
          
          if [ -z "$WORKFLOW_ID" ] || [ "$WORKFLOW_ID" = "null" ]; then
            echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID workflow"
            echo "run_id=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          LAST_RUN=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/runs?per_page=2&status=success" | \
            jq -r '.workflow_runs[] | select(.id != ${{ github.run_id }}) | .id' | head -1)
          
          if [ -z "$LAST_RUN" ] || [ "$LAST_RUN" = "null" ]; then
            echo "‚ö†Ô∏è –ü—Ä–µ–¥—ã–¥—É—â–∏–π —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—É—Å–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫)"
            echo "run_id=" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ –ù–∞–π–¥–µ–Ω –ø—Ä–µ–¥—ã–¥—É—â–∏–π —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—É—Å–∫: $LAST_RUN"
            echo "run_id=$LAST_RUN" >> $GITHUB_OUTPUT
          fi
      
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è (artifacts)
        uses: actions/download-artifact@v4
        if: steps.get-last-run.outputs.run_id != ''
        with:
          name: auto-reply-state
          path: .
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.get-last-run.outputs.run_id }}
        continue-on-error: true
      
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ artifacts..."
          if [ -f ".auto_reply_state.json" ]; then
            echo "‚úÖ –§–∞–π–ª .auto_reply_state.json –Ω–∞–π–¥–µ–Ω"
            echo "üìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
            cat .auto_reply_state.json
          else
            echo "‚ö†Ô∏è –§–∞–π–ª .auto_reply_state.json –Ω–µ –Ω–∞–π–¥–µ–Ω (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∏–ª–∏ artifacts –Ω–µ –Ω–∞–π–¥–µ–Ω—ã)"
            echo "üìù –°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞..."
            echo '{"last_update_id": 0}' > .auto_reply_state.json
          fi
          if [ -f ".answered_messages.json" ]; then
            echo "‚úÖ –§–∞–π–ª .answered_messages.json –Ω–∞–π–¥–µ–Ω"
            echo "üìä –†–∞–∑–º–µ—Ä: $(wc -l < .answered_messages.json) —Å—Ç—Ä–æ–∫"
          else
            echo "‚ö†Ô∏è –§–∞–π–ª .answered_messages.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
            echo "üìù –°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª..."
            echo '[]' > .answered_messages.json
          fi
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          pip install --upgrade pip --quiet
          pip install requests --quiet
          # –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ email –æ—Ç—á—ë—Ç–æ–≤ (–≤—Å—Ç—Ä–æ–µ–Ω–æ –≤ Python, –Ω–æ —É–±–µ–¥–∏–º—Å—è)
          python -c "import smtplib; import email" || echo "Email –º–æ–¥—É–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã"
      
      - name: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ADMIN_TELEGRAM_CHAT_ID: ${{ secrets.ADMIN_TELEGRAM_CHAT_ID }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        run: |
          python auto_reply.py
      
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
        if: always()
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ artifacts..."
          if [ -f ".auto_reply_state.json" ]; then
            echo "‚úÖ –§–∞–π–ª .auto_reply_state.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            echo "üìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
            cat .auto_reply_state.json
          else
            echo "‚ùå –§–∞–π–ª .auto_reply_state.json –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
            echo "üìù –°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º..."
            echo '{"last_update_id": 0}' > .auto_reply_state.json
          fi
          if [ -f ".answered_messages.json" ]; then
            echo "‚úÖ –§–∞–π–ª .answered_messages.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            echo "üìä –†–∞–∑–º–µ—Ä: $(wc -l < .answered_messages.json) —Å—Ç—Ä–æ–∫"
          else
            echo "‚ö†Ô∏è –§–∞–π–ª .answered_messages.json –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            echo "üìù –°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª..."
            echo '[]' > .answered_messages.json
          fi
      
      - name: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (artifacts)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: auto-reply-state
          path: |
            .auto_reply_state.json
            .answered_messages.json
          retention-days: 90

