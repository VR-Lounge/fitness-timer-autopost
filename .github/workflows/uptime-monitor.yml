name: üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞

on:
  schedule:
    # –û–¥–∏–Ω —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏ –≤ 9:00 UTC (12:00 –ø–æ –ú–æ—Å–∫–≤–µ)
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  check:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
    runs-on: ubuntu-latest
    
    steps:
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∞–π—Ç–∞
        id: check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://tabatatimer.ru)
          echo "status_code=$response" >> $GITHUB_OUTPUT
          
          if [ "$response" != "200" ]; then
            echo "is_down=true" >> $GITHUB_OUTPUT
          else
            echo "is_down=false" >> $GITHUB_OUTPUT
          fi
      
      - name: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É)
        if: steps.check.outputs.is_down == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ADMIN_TELEGRAM_CHAT_ID: ${{ secrets.ADMIN_TELEGRAM_CHAT_ID }}
          STATUS_CODE: ${{ steps.check.outputs.status_code }}
        run: |
          python3 << 'PYTHON'
          import os
          import requests
          from datetime import datetime
          
          BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
          ADMIN_CHAT_ID = os.getenv('ADMIN_TELEGRAM_CHAT_ID')
          
          if not ADMIN_CHAT_ID:
              print("‚ö†Ô∏è ADMIN_TELEGRAM_CHAT_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
              exit(0)
          
          alert = f"""üö® **–°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!**

üåê URL: https://tabatatimer.ru
‚è∞ –í—Ä–µ–º—è: {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
üìä –°—Ç–∞—Ç—É—Å: {os.getenv('STATUS_CODE', 'Unknown')}

‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞!"""
          
          send_url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
          send_params = {
              "chat_id": ADMIN_CHAT_ID,
              "text": alert,
              "parse_mode": "Markdown"
          }
          
          response = requests.post(send_url, json=send_params)
          if response.status_code == 200:
              print("üö® –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–∞–¥–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω—É –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è!")
          else:
              print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {response.status_code}")
          PYTHON
      
      - name: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        run: |
          echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω" || echo "‚ùå –°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          echo "–°—Ç–∞—Ç—É—Å –∫–æ–¥: ${{ steps.check.outputs.status_code }}"

