name: üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞

on:
  schedule:
    # –ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  check:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
    runs-on: ubuntu-latest
    
    steps:
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∞–π—Ç–∞
        id: check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://tabatatimer.ru)
          echo "status_code=$response" >> $GITHUB_OUTPUT
          
          if [ "$response" != "200" ]; then
            echo "is_down=true" >> $GITHUB_OUTPUT
          else
            echo "is_down=false" >> $GITHUB_OUTPUT
          fi
      
      - name: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
        if: steps.check.outputs.is_down == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python3 << 'PYTHON'
          import os
          import requests
          from datetime import datetime
          
          BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
          CHAT_ID = os.getenv('TELEGRAM_CHAT_ID')
          
          alert = f"""
          üö® **–°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!**
          
          üåê URL: https://tabatatimer.ru
          ‚è∞ –í—Ä–µ–º—è: {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
          üìä –°—Ç–∞—Ç—É—Å: {os.getenv('STATUS_CODE', 'Unknown')}
          
          ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞!
          """
          
          send_url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
          send_params = {
              "chat_id": CHAT_ID,
              "text": alert,
              "parse_mode": "Markdown"
          }
          requests.post(send_url, json=send_params)
          print("üö® –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–∞–¥–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
          PYTHON
        env:
          STATUS_CODE: ${{ steps.check.outputs.status_code }}
      
      - name: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        run: |
          echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω" || echo "‚ùå –°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          echo "–°—Ç–∞—Ç—É—Å –∫–æ–¥: ${{ steps.check.outputs.status_code }}"

