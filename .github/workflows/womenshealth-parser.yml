name: üíÖ –ü–∞—Ä—Å–µ—Ä Women's Health —Å —Ä–µ—Ä–∞–π—Ç–∏–Ω–≥–æ–º

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –¥–µ–Ω—å –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Telegram
    # –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ: 60% –¥–ª—è –¥–µ–≤—É—à–µ–∫, 40% –¥–ª—è –º—É–∂—á–∏–Ω
    # –¢–æ–ª—å–∫–æ 2 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å –ø—É–±–ª–∏–∫—É–µ–º –Ω–∞ —Å–∞–π—Ç (—Å HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏): —É—Ç—Ä–æ–º –∏ –≤–µ—á–µ—Ä–æ–º, –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –¥–ª—è –¥–µ–≤—É—à–µ–∫
    # –û—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏ - —Ç–æ–ª—å–∫–æ Telegram (–±–µ–∑ HTML —Å—Ç—Ä–∞–Ω–∏—Ü)
    # –î–µ–≤—É—à–∫–∏ (6 –∑–∞–ø—É—Å–∫–æ–≤ = 60%): 2 –Ω–∞ —Å–∞–π—Ç, 4 —Ç–æ–ª—å–∫–æ Telegram
    - cron: '0 6 * * *'   # 06:00 UTC (09:00 –ú–°–ö) - –¥–µ–≤—É—à–∫–∏, —Ç–æ–ª—å–∫–æ Telegram
    - cron: '0 8 * * *'   # 08:00 UTC (11:00 –ú–°–ö) - –¥–µ–≤—É—à–∫–∏, –ù–ê –°–ê–ô–¢ (HTML) - —É—Ç—Ä–æ
    - cron: '0 12 * * *'  # 12:00 UTC (15:00 –ú–°–ö) - –¥–µ–≤—É—à–∫–∏, —Ç–æ–ª—å–∫–æ Telegram
    - cron: '0 14 * * *'  # 14:00 UTC (17:00 –ú–°–ö) - –¥–µ–≤—É—à–∫–∏, —Ç–æ–ª—å–∫–æ Telegram
    - cron: '0 18 * * *'  # 18:00 UTC (21:00 –ú–°–ö) - –¥–µ–≤—É—à–∫–∏, —Ç–æ–ª—å–∫–æ Telegram
    - cron: '0 20 * * *'  # 20:00 UTC (23:00 –ú–°–ö) - –¥–µ–≤—É—à–∫–∏, –ù–ê –°–ê–ô–¢ (HTML) - –≤–µ—á–µ—Ä
  workflow_dispatch:

jobs:
  parse-and-publish:
    name: –ü–∞—Ä—Å–∏–Ω–≥ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å—Ç–∞—Ç–µ–π –¥–ª—è –¥–µ–≤—É—à–µ–∫
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      checks: read
      pull-requests: read
    
    steps:
      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è fitness-timer-autopost
        uses: actions/checkout@v4
        with:
          path: fitness-timer-autopost
      
      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è tabatatimer-ru (public_html)
        uses: actions/checkout@v4
        with:
          repository: VR-Lounge/tabatatimer-ru
          path: public_html
          token: ${{ secrets.PAT_CROSS_REPO || secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        working-directory: fitness-timer-autopost
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—å–∏)
        id: download-state
        uses: actions/download-artifact@v4
        with:
          name: womenshealth-state
          path: fitness-timer-autopost
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.run_id }}
          allow-404: true
        continue-on-error: true
      
      - name: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        if: steps.download-state.outcome == 'success'
        working-directory: fitness-timer-autopost
        run: |
          if [ -f .womenshealth_processed.json ]; then
            echo "‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ"
          else
            echo "‚ÑπÔ∏è –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫)"
          fi
      
      - name: –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
        run: |
          mkdir -p public_html/blog
          echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å–æ–∑–¥–∞–Ω–∞"
      
      - name: –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ Women's Health
        working-directory: fitness-timer-autopost
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          # –ü—É–±–ª–∏–∫—É–µ–º –Ω–∞ —Å–∞–π—Ç —Ç–æ–ª—å–∫–æ —É—Ç—Ä–æ–º (08:00) –∏ –≤–µ—á–µ—Ä–æ–º (20:00), –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –¥–ª—è –¥–µ–≤—É—à–µ–∫
          # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤ - —Ç–æ–ª—å–∫–æ Telegram
          PUBLISH_TO_BLOG: ${{ github.event.schedule == '0 8 * * *' || github.event.schedule == '0 20 * * *' || github.event_name == 'workflow_dispatch' }}
        run: |
          python3 womenshealth_parser.py
      
      - name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è –±–ª–æ–≥–∞
        if: steps.publish_mode.outputs.publish_to_blog == 'true' || github.event_name == 'workflow_dispatch'
        working-directory: fitness-timer-autopost
        run: |
          python3 generate_blog_post_page.py
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ AWS CLI –¥–ª—è –Ø–Ω–¥–µ–∫—Å Cloud
        working-directory: fitness-timer-autopost
        run: |
          pip install awscli
      
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –±–ª–æ–≥–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å Cloud
        if: steps.publish_mode.outputs.publish_to_blog == 'true' || github.event_name == 'workflow_dispatch'
        working-directory: fitness-timer-autopost
        env:
          YANDEX_ACCESS_KEY_ID: ${{ secrets.YANDEX_ACCESS_KEY_ID }}
          YANDEX_SECRET_ACCESS_KEY: ${{ secrets.YANDEX_SECRET_ACCESS_KEY }}
        run: |
          chmod +x upload_blog_to_yandex.sh
          ./upload_blog_to_yandex.sh || echo "‚ö†Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å Cloud –ø—Ä–æ–ø—É—â–µ–Ω–∞ (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)"
      
      - name: –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π tabatatimer-ru
        if: steps.publish_mode.outputs.publish_to_blog == 'true' || github.event_name == 'workflow_dispatch'
        working-directory: public_html
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_CROSS_REPO || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º remote —Å —Ç–æ–∫–µ–Ω–æ–º –¥–ª—è push (–∏—Å–ø–æ–ª—å–∑—É–µ–º PAT –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏–Ω–∞—á–µ GITHUB_TOKEN)
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/VR-Lounge/tabatatimer-ru.git
          
          if [ -n "$(git status --porcelain)" ]; then
            git add blog-posts.json blog/*.html sitemap.xml robots.txt images/blog/ 2>/dev/null || true
            git commit -m "ü§ñ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã –±–ª–æ–≥–∞ $(date +'%Y-%m-%d %H:%M:%S')" || echo "‚ö†Ô∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
            if git push origin main; then
              echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ tabatatimer-ru"
            else
              echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—à–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ tabatatimer-ru (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ø–Ω–¥–µ–∫—Å Cloud –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤)"
            fi
          else
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          fi
      
      - name: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: womenshealth-state
          path: |
            fitness-timer-autopost/.womenshealth_processed.json
            fitness-timer-autopost/.content_hashes.json
          include-hidden-files: true
          retention-days: 90
      
      - name: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        if: always()
        working-directory: fitness-timer-autopost
        run: |
          echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–∞—Ä—Å–µ—Ä–∞:"
          if [ -f .womenshealth_processed.json ]; then
            echo "‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ"
          else
            echo "‚ö†Ô∏è –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
          fi
