name: üíÖ –ü–∞—Ä—Å–µ—Ä Women's Health —Å —Ä–µ—Ä–∞–π—Ç–∏–Ω–≥–æ–º

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
    - cron: '0 8 * * *'   # 08:00 UTC (11:00 –ú–°–ö) - –¥–µ–≤—É—à–∫–∏, –ù–ê –°–ê–ô–¢ (HTML) - —É—Ç—Ä–æ
  workflow_dispatch:

jobs:
  parse-and-publish:
    name: –ü–∞—Ä—Å–∏–Ω–≥ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å—Ç–∞—Ç–µ–π –¥–ª—è –¥–µ–≤—É—à–µ–∫
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      checks: read
      pull-requests: read
    
    steps:
      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è fitness-timer-autopost
        uses: actions/checkout@v4
        with:
          path: fitness-timer-autopost
      
      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è tabatatimer-ru (public_html)
        uses: actions/checkout@v4
        with:
          repository: VR-Lounge/tabatatimer-ru
          path: public_html
          token: ${{ secrets.PAT_CROSS_REPO || secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        working-directory: fitness-timer-autopost
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ AWS CLI –¥–ª—è –Ø–Ω–¥–µ–∫—Å Cloud
        working-directory: fitness-timer-autopost
        run: |
          pip install awscli
      
      - name: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (cache)
        uses: actions/cache/restore@v4
        with:
          path: |
            fitness-timer-autopost/.womenshealth_processed.json
            fitness-timer-autopost/.content_hashes.json
            fitness-timer-autopost/content_library.json
            fitness-timer-autopost/.telegram_recent.json
            fitness-timer-autopost/.publication_logs.json
          key: womenshealth-state-${{ github.run_id }}
          restore-keys: |
            womenshealth-state-
      
      - name: –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
        run: |
          mkdir -p public_html/blog
          echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å–æ–∑–¥–∞–Ω–∞"
      
      - name: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
        id: set_publish_flag
        run: |
          # –î–ª—è workflow_dispatch –≤—Å–µ–≥–¥–∞ –ø—É–±–ª–∏–∫—É–µ–º –Ω–∞ —Å–∞–π—Ç
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "PUBLISH_TO_BLOG=true" >> $GITHUB_OUTPUT
            echo "üìù –†–µ–∂–∏–º: –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–∞ —Å–∞–π—Ç + Telegram (workflow_dispatch)"
          else
            # –î–ª—è schedule: –ø—É–±–ª–∏–∫—É–µ–º –Ω–∞ —Å–∞–π—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–∞—Ö 08:00 –∏ 20:00 UTC
            HOUR_UTC=$(date -u +%H)
            if [ "$HOUR_UTC" = "08" ] || [ "$HOUR_UTC" = "20" ]; then
              echo "PUBLISH_TO_BLOG=true" >> $GITHUB_OUTPUT
              echo "üìù –†–µ–∂–∏–º: –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–∞ —Å–∞–π—Ç + Telegram (schedule)"
            else
              echo "PUBLISH_TO_BLOG=false" >> $GITHUB_OUTPUT
              echo "üì± –†–µ–∂–∏–º: —Ç–æ–ª—å–∫–æ Telegram (–±–µ–∑ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ —Å–∞–π—Ç)"
            fi
          fi
      
      - name: –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ Women's Health
        working-directory: fitness-timer-autopost
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          YANDEX_ACCESS_KEY_ID: ${{ secrets.YANDEX_ACCESS_KEY_ID }}
          YANDEX_SECRET_ACCESS_KEY: ${{ secrets.YANDEX_SECRET_ACCESS_KEY }}
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —à–∞–≥–∞ –≤—ã—à–µ (–¥–ª—è workflow_dispatch –≤—Å–µ–≥–¥–∞ true)
          PUBLISH_TO_BLOG: ${{ steps.set_publish_flag.outputs.PUBLISH_TO_BLOG || 'true' }}
          SKINNYMS_ONLY: "true"
          SKINNYMS_CATEGORIES: "fitness,recipes"
          SKINNYMS_MAX_ARTICLES_PER_RUN: "40"
        run: |
          python3 skinnyms_parser.py
          python3 womenshealth_parser.py

      - name: –ö–æ–º–º–∏—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        if: always()
        working-directory: fitness-timer-autopost
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_CROSS_REPO || secrets.GITHUB_TOKEN }}
        run: |
          if [ -f content_library.json ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/VR-Lounge/fitness-timer-autopost.git
            git add content_library.json
            if git diff --cached --quiet; then
              echo "‚ÑπÔ∏è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å"
            else
              git commit -m "üìö –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ $(date +'%Y-%m-%d %H:%M:%S')" || echo "‚ö†Ô∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
              if git push origin main; then
                echo "‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ fitness-timer-autopost"
              else
                echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞"
              fi
            fi
          else
            echo "‚ÑπÔ∏è content_library.json –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞—é –∫–æ–º–º–∏—Ç"
          fi
      
      - name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è –±–ª–æ–≥–∞
        working-directory: fitness-timer-autopost
        run: |
          python3 generate_blog_post_page.py
      
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –±–ª–æ–≥–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å Cloud
        working-directory: fitness-timer-autopost
        env:
          YANDEX_ACCESS_KEY_ID: ${{ secrets.YANDEX_ACCESS_KEY_ID }}
          YANDEX_SECRET_ACCESS_KEY: ${{ secrets.YANDEX_SECRET_ACCESS_KEY }}
        run: |
          chmod +x upload_blog_to_yandex.sh
          ./upload_blog_to_yandex.sh || echo "‚ö†Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å Cloud –ø—Ä–æ–ø—É—â–µ–Ω–∞ (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)"
      
      - name: –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π tabatatimer-ru
        working-directory: public_html
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_CROSS_REPO || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º remote —Å —Ç–æ–∫–µ–Ω–æ–º –¥–ª—è push (–∏—Å–ø–æ–ª—å–∑—É–µ–º PAT –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏–Ω–∞—á–µ GITHUB_TOKEN)
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/VR-Lounge/tabatatimer-ru.git
          
          if [ -n "$(git status --porcelain)" ]; then
            git add blog-posts.json blog/*.html sitemap.xml robots.txt images/blog/ 2>/dev/null || true
            git commit -m "ü§ñ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã –±–ª–æ–≥–∞ $(date +'%Y-%m-%d %H:%M:%S')" || echo "‚ö†Ô∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
            if git push origin main; then
              echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ tabatatimer-ru"
            else
              echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—à–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ tabatatimer-ru (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ø–Ω–¥–µ–∫—Å Cloud –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤)"
            fi
          else
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          fi
      
      - name: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (cache)
        uses: actions/cache/save@v4
        if: always()
        with:
          path: |
            fitness-timer-autopost/.womenshealth_processed.json
            fitness-timer-autopost/.content_hashes.json
            fitness-timer-autopost/content_library.json
            fitness-timer-autopost/.telegram_recent.json
            fitness-timer-autopost/.publication_logs.json
          key: womenshealth-state-${{ github.run_id }}
      
      - name: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        if: always()
        working-directory: fitness-timer-autopost
        run: |
          echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–∞—Ä—Å–µ—Ä–∞:"
          if [ -f .womenshealth_processed.json ]; then
            echo "‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ"
          else
            echo "‚ö†Ô∏è –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
          fi
