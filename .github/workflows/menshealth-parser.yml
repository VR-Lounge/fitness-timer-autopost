name: üì∞ –ü–∞—Ä—Å–µ—Ä Men's Health —Å —Ä–µ—Ä–∞–π—Ç–∏–Ω–≥–æ–º

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ–º 2 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å (—É—Ç—Ä–æ–º –∏ –≤–µ—á–µ—Ä–æ–º) –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–æ–≤—ã—Ö —Å—Ç–∞—Ç–µ–π
    - cron: '0 8 * * *'   # 08:00 UTC (11:00 –ú–°–ö)
    - cron: '0 20 * * *'  # 20:00 UTC (23:00 –ú–°–ö)
  workflow_dispatch:

jobs:
  parse-and-publish:
    name: –ü–∞—Ä—Å–∏–Ω–≥ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å—Ç–∞—Ç–µ–π
    runs-on: ubuntu-latest
    
    steps:
      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        working-directory: fitness-timer-autopost
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—å–∏)
        id: download-state
        uses: actions/download-artifact@v4
        with:
          name: menshealth-state
          path: fitness-timer-autopost
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.run_id }}
          allow-404: true
        continue-on-error: true
      
      - name: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        working-directory: fitness-timer-autopost
        if: steps.download-state.outcome == 'success'
        run: |
          if [ -f .menshealth_processed.json ]; then
            echo "‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ"
          else
            echo "‚ÑπÔ∏è –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫)"
          fi
      
      - name: –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ Men's Health
        working-directory: fitness-timer-autopost
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          python3 menshealth_parser.py
      
      - name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è –±–ª–æ–≥–∞
        working-directory: fitness-timer-autopost
        run: |
          python3 generate_blog_post_page.py
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ AWS CLI –¥–ª—è –Ø–Ω–¥–µ–∫—Å Cloud
        run: |
          pip install awscli
      
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –±–ª–æ–≥–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å Cloud
        working-directory: fitness-timer-autopost
        env:
          YANDEX_ACCESS_KEY_ID: ${{ secrets.YANDEX_ACCESS_KEY_ID }}
          YANDEX_SECRET_ACCESS_KEY: ${{ secrets.YANDEX_SECRET_ACCESS_KEY }}
        run: |
          chmod +x upload_blog_to_yandex.sh
          ./upload_blog_to_yandex.sh || echo "‚ö†Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å Cloud –ø—Ä–æ–ø—É—â–µ–Ω–∞ (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)"
      
      - name: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        uses: actions/upload-artifact@v4
        with:
          name: menshealth-state
          path: |
            fitness-timer-autopost/.menshealth_processed.json
            fitness-timer-autopost/.content_hashes.json
          include-hidden-files: true
          retention-days: 90
      
      - name: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        if: always()
        run: |
          echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–∞—Ä—Å–µ—Ä–∞:"
          if [ -f .menshealth_processed.json ]; then
            echo "‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ"
          else
            echo "‚ö†Ô∏è –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
          fi
