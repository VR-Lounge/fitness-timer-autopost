# Workflow ¬´–†–µ—Ü–µ–ø—Ç—ã –∏ –ø–∏—Ç–∞–Ω–∏–µ¬ª ‚Äî –ø–æ –æ–±—Ä–∞–∑—Ü—É —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ (11:00 –ú–°–ö).
# –¢–æ–ª—å–∫–æ —Ä–µ—Ü–µ–ø—Ç—ã –∏ –∑–¥–æ—Ä–æ–≤–æ–µ –ø–∏—Ç–∞–Ω–∏–µ –∏–∑ SkinnyMs, –ø—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ —Å–∞–π—Ç + Telegram.
# Telegram: —Ñ–æ—Ç–æ –±–ª—é–¥–∞ + —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Å—Ç (‚è±Ô∏è –≤—Ä–µ–º—è, üõí –ø—Ä–æ–¥—É–∫—Ç—ã —Å —Ü–µ–Ω–∞–º–∏ –ø–æ —Å–µ—Ç—è–º –†–æ—Å—Å–∏–∏
#   –ü—è—Ç—ë—Ä–æ—á–∫–∞/–ú–∞–≥–Ω–∏—Ç/–ü–µ—Ä–µ–∫—Ä—ë—Å—Ç–æ–∫/–ê—à–∞–Ω/–ú–µ—Ç—Ä–æ/–í–∫—É—Å–í–∏–ª–ª/–î–∏–∫—Å–∏, üìù —Å–ø–æ—Å–æ–±, üìä –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã, üî¨ –ø–æ–ª—å–∑–∞, üí° –ª–∞–π—Ñ—Ö–∞–∫).
# –ù–∞ —Å–∞–π—Ç: –ø–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç—å—è —Å —Ç–µ–º –∂–µ —Ç–æ–Ω–æ–º (–∂–∏–∑–Ω–µ–Ω–Ω—ã–π, –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π, –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥).
# –ó–∞–ø—É—Å–∫: 17:25 –ú–°–ö (14:25 UTC) 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å.

name: üçΩÔ∏è –†–µ—Ü–µ–ø—Ç—ã –∏ –ø–∏—Ç–∞–Ω–∏–µ (SkinnyMs)

on:
  schedule:
    - cron: '25 14 * * *'   # 14:25 UTC (17:25 –ú–°–ö) ‚Äî —Ä–µ—Ü–µ–ø—Ç—ã –∏ –ø–∏—Ç–∞–Ω–∏–µ, –ù–ê –°–ê–ô–¢ + Telegram
  workflow_dispatch:

jobs:
  parse-and-publish:
    name: –ü–∞—Ä—Å–∏–Ω–≥ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–µ—Ü–µ–ø—Ç–æ–≤ –∏ –∑–¥–æ—Ä–æ–≤–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      checks: read
      pull-requests: read

    steps:
      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è fitness-timer-autopost
        uses: actions/checkout@v4
        with:
          path: fitness-timer-autopost

      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è tabatatimer-ru (public_html)
        uses: actions/checkout@v4
        with:
          repository: VR-Lounge/tabatatimer-ru
          path: public_html
          token: ${{ secrets.PAT_CROSS_REPO || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        working-directory: fitness-timer-autopost
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ AWS CLI –¥–ª—è –Ø–Ω–¥–µ–∫—Å Cloud
        working-directory: fitness-timer-autopost
        run: |
          pip install awscli

      - name: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (cache)
        uses: actions/cache/restore@v4
        with:
          path: |
            fitness-timer-autopost/.womenshealth_processed.json
            fitness-timer-autopost/.content_hashes.json
            fitness-timer-autopost/content_library.json
            fitness-timer-autopost/.telegram_recent.json
            fitness-timer-autopost/.publication_logs.json
            fitness-timer-autopost/.skinnyms_queue.json
          key: womenshealth-state-${{ github.run_id }}
          restore-keys: |
            womenshealth-state-

      - name: –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
        run: |
          mkdir -p public_html/blog
          echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å–æ–∑–¥–∞–Ω–∞"

      - name: –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤ (SkinnyMs) –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è
        working-directory: fitness-timer-autopost
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          YANDEX_ACCESS_KEY_ID: ${{ secrets.YANDEX_ACCESS_KEY_ID }}
          YANDEX_SECRET_ACCESS_KEY: ${{ secrets.YANDEX_SECRET_ACCESS_KEY }}
          PUBLISH_TO_BLOG: "true"
          RECIPES_ONLY: "true"
          SKINNYMS_CATEGORIES: "recipes"
          SKINNYMS_MAX_ARTICLES_PER_RUN: "40"
        run: |
          python3 skinnyms_parser.py
          python3 womenshealth_parser.py

      - name: –ö–æ–º–º–∏—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        if: always()
        working-directory: fitness-timer-autopost
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_CROSS_REPO || secrets.GITHUB_TOKEN }}
        run: |
          if [ -f content_library.json ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/VR-Lounge/fitness-timer-autopost.git
            git add content_library.json
            if git diff --cached --quiet; then
              echo "‚ÑπÔ∏è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å"
            else
              git commit -m "üìö –†–µ—Ü–µ–ø—Ç—ã: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ $(date +'%Y-%m-%d %H:%M:%S')" || echo "‚ö†Ô∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
              if git push origin main; then
                echo "‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ fitness-timer-autopost"
              else
                echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞"
              fi
            fi
          else
            echo "‚ÑπÔ∏è content_library.json –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞—é –∫–æ–º–º–∏—Ç"
          fi

      - name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è –±–ª–æ–≥–∞
        working-directory: fitness-timer-autopost
        run: |
          python3 generate_blog_post_page.py

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –±–ª–æ–≥–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å Cloud
        working-directory: fitness-timer-autopost
        env:
          YANDEX_ACCESS_KEY_ID: ${{ secrets.YANDEX_ACCESS_KEY_ID }}
          YANDEX_SECRET_ACCESS_KEY: ${{ secrets.YANDEX_SECRET_ACCESS_KEY }}
        run: |
          chmod +x upload_blog_to_yandex.sh
          ./upload_blog_to_yandex.sh || echo "‚ö†Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å Cloud –ø—Ä–æ–ø—É—â–µ–Ω–∞ (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)"

      - name: –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π tabatatimer-ru
        working-directory: public_html
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_CROSS_REPO || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/VR-Lounge/tabatatimer-ru.git

          if [ -n "$(git status --porcelain)" ]; then
            git add blog-posts.json blog/*.html sitemap.xml robots.txt images/blog/ 2>/dev/null || true
            git commit -m "ü§ñ –†–µ—Ü–µ–ø—Ç—ã: –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–ª–æ–≥–∞ $(date +'%Y-%m-%d %H:%M:%S')" || echo "‚ö†Ô∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
            if git push origin main; then
              echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ tabatatimer-ru"
            else
              echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—à–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ tabatatimer-ru"
            fi
          else
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          fi

      - name: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (cache)
        uses: actions/cache/save@v4
        if: always()
        with:
          path: |
            fitness-timer-autopost/.womenshealth_processed.json
            fitness-timer-autopost/.content_hashes.json
            fitness-timer-autopost/content_library.json
            fitness-timer-autopost/.telegram_recent.json
            fitness-timer-autopost/.publication_logs.json
            fitness-timer-autopost/.skinnyms_queue.json
          key: womenshealth-state-${{ github.run_id }}

      - name: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        if: always()
        working-directory: fitness-timer-autopost
        run: |
          echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–∞—Ä—Å–µ—Ä–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤:"
          if [ -f .skinnyms_queue.json ]; then
            echo "‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ SkinnyMs —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ"
          fi
          if [ -f .womenshealth_processed.json ]; then
            echo "‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ"
          fi
