name: ü§ñ –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ–º 2 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é –¥–ª—è –±–æ–ª–µ–µ —á–∞—Å—Ç–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    - cron: '0 10 * * 1'  # –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ 10:00 UTC (13:00 –ú–°–ö)
    - cron: '0 10 * * 4'  # –ß–µ—Ç–≤–µ—Ä–≥ 10:00 UTC (13:00 –ú–°–ö)
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  autonomous-testing:
    name: –ê–≤—Ç–æ–Ω–æ–º–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    runs-on: ubuntu-latest
    
    steps:
      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: –ê–≤—Ç–æ–Ω–æ–º–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
        run: |
          python3 autonomous_testing.py
      
      - name: –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          python3 autonomous_monitor.py
      
      - name: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–æ–≤
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "üß™ –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –ø–∞—Ä—Å–µ—Ä–æ–≤..."
          python3 test_autopost_system.py || echo "‚ö†Ô∏è –¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏"
      
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å Yandex Cloud
        env:
          YANDEX_ACCESS_KEY_ID: ${{ secrets.YANDEX_ACCESS_KEY_ID }}
          YANDEX_SECRET_ACCESS_KEY: ${{ secrets.YANDEX_SECRET_ACCESS_KEY }}
        run: |
          echo "‚òÅÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Yandex Cloud..."
          if [ -n "$YANDEX_ACCESS_KEY_ID" ] && [ -n "$YANDEX_SECRET_ACCESS_KEY" ]; then
            pip install awscli --quiet
            export AWS_ACCESS_KEY_ID="$YANDEX_ACCESS_KEY_ID"
            export AWS_SECRET_ACCESS_KEY="$YANDEX_SECRET_ACCESS_KEY"
            export AWS_DEFAULT_REGION="ru-central1"
            aws s3 ls s3://www.tabatatimer.ru --endpoint-url=https://storage.yandexcloud.net > /dev/null 2>&1 && \
              echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Yandex Cloud —É—Å–ø–µ—à–Ω–æ" || \
              echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Yandex Cloud"
          else
            echo "‚ö†Ô∏è Yandex Cloud credentials –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
          fi
      
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–æ–≤
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            test_report.json
            monitoring_report_*.md
          retention-days: 30
      
      - name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–∞—Ö
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ADMIN_TELEGRAM_CHAT_ID: ${{ secrets.ADMIN_TELEGRAM_CHAT_ID }}
        run: |
          python3 -c "
          import requests
          import os
          token = os.getenv('TELEGRAM_BOT_TOKEN')
          chat_id = os.getenv('ADMIN_TELEGRAM_CHAT_ID')
          if token and chat_id:
              url = f'https://api.telegram.org/bot{token}/sendMessage'
              requests.post(url, json={
                  'chat_id': chat_id,
                  'text': '‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ GitHub Actions.'
              })
          "
