name: üé≤ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂

on:
  schedule:
    # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 08:00 –ú–°–ö (05:00 UTC)
    - cron: '0 5 * * *'
  workflow_dispatch:

jobs:
  challenge:
    name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ–ª–ª–µ–Ω–¥–∂–∞
    runs-on: ubuntu-latest
    
    steps:
      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          pip install python-telegram-bot requests
      
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–µ–ª–ª–µ–Ω–¥–∂–µ–π
        id: load-history
        run: |
          if [ -f ".challenge_history.json" ]; then
            echo "‚úÖ –ò—Å—Ç–æ—Ä–∏—è —á–µ–ª–ª–µ–Ω–¥–∂–µ–π –Ω–∞–π–¥–µ–Ω–∞"
          else
            echo "üìù –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é"
            echo '[]' > .challenge_history.json
          fi
        continue-on-error: true
      
      - name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ–ª–ª–µ–Ω–¥–∂–∞ —á–µ—Ä–µ–∑ DeepSeek AI
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          python3 << 'PYTHON'
          import os
          import requests
          import json
          import random
          from datetime import datetime
          from pathlib import Path
          
          BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
          CHAT_ID = os.getenv('TELEGRAM_CHAT_ID')
          DEEPSEEK_KEY = os.getenv('DEEPSEEK_API_KEY')
          
          # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–µ–ª–ª–µ–Ω–¥–∂–µ–π
          history_file = Path('.challenge_history.json')
          if history_file.exists():
              with open(history_file, 'r', encoding='utf-8') as f:
                  history = json.load(f)
          else:
              history = []
          
          # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —á–µ–ª–ª–µ–Ω–¥–∂–µ–π –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
          recent_challenges = [h.get('challenge', '') for h in history[-30:]]
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂ —á–µ—Ä–µ–∑ DeepSeek AI
          day = datetime.now().strftime('%d.%m.%Y')
          day_of_week = datetime.now().strftime('%A')
          
          prompt = f"""–°–æ–∑–¥–∞–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—á–µ–ª–ª–µ–Ω–¥–∂ –¥–ª—è {day_of_week.lower()} ({day}).

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π (–Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π: {', '.join(recent_challenges[:5]) if recent_challenges else '–Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏'})
- –í—ã–ø–æ–ª–Ω–∏–º—ã–π –¥–æ–º–∞ –±–µ–∑ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
- 1-3 –º–∏–Ω—É—Ç—ã –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
- –ú–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ª—é–±–æ–≥–æ —É—Ä–æ–≤–Ω—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —á–µ–ª–ª–µ–Ω–¥–∂–∞, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–ª–æ–≤):
[—Ç–µ–∫—Å—Ç —á–µ–ª–ª–µ–Ω–¥–∂–∞]"""
          
          # –ó–∞–ø—Ä–æ—Å –∫ DeepSeek AI
          challenge_text = None
          if DEEPSEEK_KEY:
              try:
                  deepseek_url = "https://api.deepseek.com/v1/chat/completions"
                  headers = {
                      "Authorization": f"Bearer {DEEPSEEK_KEY}",
                      "Content-Type": "application/json"
                  }
                  data = {
                      "model": "deepseek-chat",
                      "messages": [
                          {"role": "system", "content": "–¢—ã —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä, —Å–æ–∑–¥–∞—é—â–∏–π –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–µ —á–µ–ª–ª–µ–Ω–¥–∂–∏."},
                          {"role": "user", "content": prompt}
                      ],
                      "temperature": 0.8,
                      "max_tokens": 150
                  }
                  
                  response = requests.post(deepseek_url, headers=headers, json=data, timeout=30)
                  if response.status_code == 200:
                      result = response.json()
                      challenge_text = result.get('choices', [{}])[0].get('message', {}).get('content', '').strip()
                      print(f"‚úÖ –ß–µ–ª–ª–µ–Ω–¥–∂ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ DeepSeek AI")
              except Exception as e:
                  print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ DeepSeek AI: {e}, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback")
          
          # Fallback –Ω–∞ —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ DeepSeek –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
          if not challenge_text:
              fallback_challenges = [
                  "20 –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π –∑–∞ 1 –º–∏–Ω—É—Ç—É",
                  "–ü–ª–∞–Ω–∫–∞ 60 —Å–µ–∫—É–Ω–¥",
                  "10 –æ—Ç–∂–∏–º–∞–Ω–∏–π",
                  "30 —Å–µ–∫—É–Ω–¥ –±–µ—Ä–ø–∏",
                  "20 –≤—ã–ø–∞–¥–æ–≤ –Ω–∞ –∫–∞–∂–¥—É—é –Ω–æ–≥—É",
                  "15 –±—ë—Ä–ø–∏ –∑–∞ 2 –º–∏–Ω—É—Ç—ã",
                  "–ü–ª–∞–Ω–∫–∞ —Å –ø–æ–¥–Ω—è—Ç–∏–µ–º –Ω–æ–≥–∏ 45 —Å–µ–∫—É–Ω–¥",
                  "25 –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π —Å –ø—Ä—ã–∂–∫–æ–º",
                  "10 –æ—Ç–∂–∏–º–∞–Ω–∏–π —Å –ø–∞—É–∑–æ–π –≤–Ω–∏–∑—É",
                  "–ü–ª–∞–Ω–∫–∞ —Å –∫–∞—Å–∞–Ω–∏–µ–º –ø–ª–µ—á–∞ 60 —Å–µ–∫—É–Ω–¥"
              ]
              # –ò—Å–∫–ª—é—á–∞–µ–º –Ω–µ–¥–∞–≤–Ω–∏–µ —á–µ–ª–ª–µ–Ω–¥–∂–∏
              available = [c for c in fallback_challenges if c not in recent_challenges]
              challenge_text = random.choice(available if available else fallback_challenges)
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ—Å—Ç
          post = f"""üé≤ **–ß–µ–ª–ª–µ–Ω–¥–∂ –¥–Ω—è {day}**

üí™ –ó–∞–¥–∞–Ω–∏–µ: {challenge_text}

‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!

üì∏ –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö!

üî• –£–¥–∞—á–∏! –í—ã —Å–ø—Ä–∞–≤–∏—Ç–µ—Å—å!

#–ß–µ–ª–ª–µ–Ω–¥–∂ #–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ #–ú–æ—Ç–∏–≤–∞—Ü–∏—è"""
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
          send_url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
          send_params = {
              "chat_id": CHAT_ID,
              "text": post,
              "parse_mode": "Markdown"
          }
          
          response = requests.post(send_url, json=send_params)
          if response.status_code == 200:
              result_data = response.json()
              message_id = result_data.get('result', {}).get('message_id')
              
              # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
              history.append({
                  'date': day,
                  'challenge': challenge_text,
                  'message_id': message_id,
                  'timestamp': datetime.now().isoformat()
              })
              
              # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 –∑–∞–ø–∏—Å–µ–π
              history = history[-100:]
              
              with open(history_file, 'w', encoding='utf-8') as f:
                  json.dump(history, f, ensure_ascii=False, indent=2)
              
              print("‚úÖ –ß–µ–ª–ª–µ–Ω–¥–∂ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –∏—Å—Ç–æ—Ä–∏—é!")
          else:
              print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {response.status_code}")
          PYTHON
      
      - name: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–µ–ª–ª–µ–Ω–¥–∂–µ–π
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: challenge-history
          path: .challenge_history.json
          retention-days: 90
          if-no-files-found: ignore

