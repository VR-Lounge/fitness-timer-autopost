name: üîç SEO-–∞—É–¥–∏—Ç —Å–∞–π—Ç–∞

on:
  schedule:
    # –ö–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 08:00 –ú–°–ö (05:00 UTC)
    - cron: '0 5 * * 1'
  workflow_dispatch:
    inputs:
      url:
        description: 'URL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏'
        required: false
        default: 'https://tabatatimer.ru'

jobs:
  lighthouse:
    name: Lighthouse SEO Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
      
      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è tabatatimer-ru –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
        uses: actions/checkout@v4
        with:
          repository: VR-Lounge/tabatatimer-ru
          path: public_html
          token: ${{ secrets.PAT_CROSS_REPO || secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –±–ª–æ–≥–∞
        id: get-blog-pages
        run: |
          python3 << 'PYTHON'
          import json
          from pathlib import Path
          
          blog_posts_file = Path('public_html/blog-posts.json')
          base_urls = ['https://tabatatimer.ru', 'https://tabatatimer.ru/#timer']
          
          if blog_posts_file.exists():
              with open(blog_posts_file, 'r', encoding='utf-8') as f:
                  data = json.load(f)
              
              posts = data.get('posts', [])
              blog_urls = []
              for post in posts[:10]:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç–∞—Ç–µ–π –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
                  url = post.get('url', '')
                  if url and url.startswith('/blog/'):
                      full_url = f"https://tabatatimer.ru{url}"
                      blog_urls.append(full_url)
              
              print(f"üìÑ –ù–∞–π–¥–µ–Ω–æ {len(posts)} —Å—Ç–∞—Ç–µ–π, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10")
              print(f"üîó URL —Å—Ç–∞—Ç–µ–π: {', '.join(blog_urls[:3])}...")
          else:
              blog_urls = []
              print("‚ö†Ô∏è blog-posts.json –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã")
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ URL –≤ —Ñ–∞–π–ª –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ
          all_urls = base_urls + blog_urls
          with open('lighthouse_urls.txt', 'w') as f:
              f.write('\n'.join(all_urls))
          
          print(f"‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ {len(all_urls)} URL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏")
          PYTHON
      
      - name: –ó–∞–ø—É—Å–∫ Lighthouse CI –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://tabatatimer.ru
            https://tabatatimer.ru/#timer
          configPath: ./fitness-timer-autopost/.lighthouserc.json
          uploadArtifacts: true
          temporaryPublicStorage: true
      
      - name: –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –æ—Ç—á—ë—Ç–æ–≤ Lighthouse
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ADMIN_TELEGRAM_CHAT_ID: ${{ secrets.ADMIN_TELEGRAM_CHAT_ID }}
        run: |
          python3 << 'PYTHON'
          import os
          import requests
          import json
          from pathlib import Path
          from datetime import datetime
          
          BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
          ADMIN_CHAT_ID = os.getenv('ADMIN_TELEGRAM_CHAT_ID')
          
          def analyze_lighthouse_report(report_path):
              """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—Ç—á—ë—Ç Lighthouse –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏"""
              try:
                  with open(report_path, 'r', encoding='utf-8') as f:
                      data = json.load(f)
                  
                  categories = data.get('categories', {})
                  audits = data.get('audits', {})
                  
                  metrics = {}
                  for cat_name, cat_data in categories.items():
                      score = cat_data.get('score', 0)
                      metrics[cat_name] = {
                          'score': score,
                          'percentage': int(score * 100) if score else 0
                      }
                  
                  # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                  recommendations = []
                  
                  # Performance —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                  if audits.get('render-blocking-resources', {}).get('score', 1) < 1:
                      recommendations.append("üö´ –£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã (CSS/JS)")
                  
                  if audits.get('unused-css-rules', {}).get('score', 1) < 1:
                      recommendations.append("üì¶ –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π CSS")
                  
                  if audits.get('unused-javascript', {}).get('score', 1) < 1:
                      recommendations.append("üì¶ –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π JavaScript")
                  
                  if audits.get('modern-image-formats', {}).get('score', 1) < 1:
                      recommendations.append("üñºÔ∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WebP/AVIF –≤–º–µ—Å—Ç–æ JPEG/PNG")
                  
                  if audits.get('image-size-responsive', {}).get('score', 1) < 1:
                      recommendations.append("üìê –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
                  
                  # SEO —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                  if audits.get('meta-description', {}).get('score', 1) < 1:
                      recommendations.append("üìù –î–æ–±–∞–≤–∏—Ç—å meta-description –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü")
                  
                  if audits.get('document-title', {}).get('score', 1) < 1:
                      recommendations.append("üìÑ –£–ª—É—á—à–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü (title)")
                  
                  if audits.get('link-text', {}).get('score', 1) < 1:
                      recommendations.append("üîó –£–ª—É—á—à–∏—Ç—å —Ç–µ–∫—Å—Ç—ã —Å—Å—ã–ª–æ–∫ (anchor text)")
                  
                  # Accessibility —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                  if audits.get('image-alt', {}).get('score', 1) < 1:
                      recommendations.append("‚ôø –î–æ–±–∞–≤–∏—Ç—å alt-—Ç–µ–∫—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
                  
                  if audits.get('color-contrast', {}).get('score', 1) < 1:
                      recommendations.append("üé® –£–ª—É—á—à–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å —Ü–≤–µ—Ç–æ–≤")
                  
                  return metrics, recommendations
              except Exception as e:
                  return None, [f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {e}"]
          
          # –ò—â–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã Lighthouse
          results_path = Path('.lighthouseci')
          all_metrics = {}
          all_recommendations = []
          
          if results_path.exists():
              # –ò—â–µ–º –≤—Å–µ JSON –æ—Ç—á—ë—Ç—ã
              json_reports = list(results_path.glob('**/*.json'))
              
              for report_file in json_reports[:5]:  # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ 5 –æ—Ç—á—ë—Ç–æ–≤
                  metrics, recommendations = analyze_lighthouse_report(report_file)
                  if metrics:
                      # –û–±—ä–µ–¥–∏–Ω—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ (–±–µ—Ä—ë–º —Å—Ä–µ–¥–Ω–µ–µ)
                      for cat, data in metrics.items():
                          if cat not in all_metrics:
                              all_metrics[cat] = {'scores': [], 'percentage': 0}
                          all_metrics[cat]['scores'].append(data['percentage'])
                      
                      all_recommendations.extend(recommendations)
              
              # –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
              for cat in all_metrics:
                  scores = all_metrics[cat]['scores']
                  if scores:
                      all_metrics[cat]['percentage'] = int(sum(scores) / len(scores))
              
              # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
              unique_recommendations = list(set(all_recommendations))
              
              # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç
              performance = all_metrics.get('performance', {}).get('percentage', 0)
              accessibility = all_metrics.get('accessibility', {}).get('percentage', 0)
              best_practices = all_metrics.get('best-practices', {}).get('percentage', 0)
              seo = all_metrics.get('seo', {}).get('percentage', 0)
              
              # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
              overall_score = (performance + accessibility + best_practices + seo) / 4
              status_emoji = "‚úÖ" if overall_score >= 80 else "‚ö†Ô∏è" if overall_score >= 60 else "‚ùå"
              
              report = f"""üîç **SEO-–∞—É–¥–∏—Ç —Å–∞–π—Ç–∞ tabatatimer.ru**

{status_emoji} –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ({len(json_reports)} —Å—Ç—Ä–∞–Ω–∏—Ü)

üìä **–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
‚Ä¢ Performance: {performance}% {'‚úÖ' if performance >= 80 else '‚ö†Ô∏è' if performance >= 60 else '‚ùå'}
‚Ä¢ Accessibility: {accessibility}% {'‚úÖ' if accessibility >= 80 else '‚ö†Ô∏è' if accessibility >= 60 else '‚ùå'}
‚Ä¢ Best Practices: {best_practices}% {'‚úÖ' if best_practices >= 80 else '‚ö†Ô∏è' if best_practices >= 60 else '‚ùå'}
‚Ä¢ SEO: {seo}% {'‚úÖ' if seo >= 80 else '‚ö†Ô∏è' if seo >= 60 else '‚ùå'}

üìà **–û–±—â–∏–π –±–∞–ª–ª:** {int(overall_score)}%

üí° **–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**"""
              
              if unique_recommendations:
                  for i, rec in enumerate(unique_recommendations[:10], 1):  # –ü–µ—Ä–≤—ã–µ 10
                      report += f"\n{i}. {rec}"
              else:
                  report += "\n‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
              
              report += f"\n\nüìÖ –î–∞—Ç–∞: {datetime.now().strftime('%d.%m.%Y %H:%M')}"
              
              # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á—ë—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
              if ADMIN_CHAT_ID:
                  send_url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
                  admin_params = {
                      "chat_id": ADMIN_CHAT_ID,
                      "text": report,
                      "parse_mode": "Markdown"
                  }
                  
                  response = requests.post(send_url, json=admin_params)
                  if response.status_code == 200:
                      print("‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–π SEO-–æ—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω—É –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è!")
                  else:
                      print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á—ë—Ç–∞: {response.status_code}")
              else:
                  print("‚ö†Ô∏è ADMIN_TELEGRAM_CHAT_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –æ—Ç—á—ë—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")
          else:
              error_msg = "‚ö†Ô∏è –û—Ç—á—ë—Ç Lighthouse –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ workflow."
              print(error_msg)
              if BOT_TOKEN and ADMIN_CHAT_ID:
                  requests.post(
                      f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage",
                      json={"chat_id": ADMIN_CHAT_ID, "text": error_msg}
                  )
          PYTHON
      
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: seo-audit-reports
          path: |
            .lighthouseci/**/*.json
            .lighthouseci/**/*.html
          retention-days: 30

