name: üìä –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–Ω–∞–ª–∞

on:
  schedule:
    # –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 10:00 –ú–°–ö (07:00 UTC)
    - cron: '0 7 * * 1'
  workflow_dispatch:

jobs:
  stats:
    name: –°–±–æ—Ä –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    runs-on: ubuntu-latest
    
    steps:
      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          pip install python-telegram-bot requests matplotlib pandas
      
      - name: –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python3 << 'PYTHON'
          import os
          import requests
          from datetime import datetime, timedelta
          from io import BytesIO
          
          BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
          CHAT_ID = os.getenv('TELEGRAM_CHAT_ID')
          
          # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–Ω–∞–ª–∞
          url = f"https://api.telegram.org/bot{BOT_TOKEN}/getChat"
          params = {"chat_id": CHAT_ID}
          response = requests.get(url, params=params)
          
          if response.status_code == 200:
              data = response.json()
              members_count = data.get('result', {}).get('members_count', 'N/A')
              
              # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á—ë—Ç
              week_start = (datetime.now() - timedelta(days=7)).strftime('%d.%m.%Y')
              week_end = datetime.now().strftime('%d.%m.%Y')
              
              report = f"""
          üìä **–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–Ω–∞–ª–∞**
          
          üìÖ –ü–µ—Ä–∏–æ–¥: {week_start} - {week_end}
          
          üë• –ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤: {members_count}
          
          üìà –†–æ—Å—Ç –∑–∞ –Ω–µ–¥–µ–ª—é: [—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏]
          
          üî• –¢–æ–ø-3 –ø–æ—Å—Ç–∞ –Ω–µ–¥–µ–ª–∏:
          1. [—Å–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π]
          2. [–≤—Ç–æ—Ä–æ–π –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏]
          3. [—Ç—Ä–µ—Ç–∏–π –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏]
          
          üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
          - –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ 09:17 –∏ 17:23
          - –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
          
          #–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ #–û—Ç—á—ë—Ç
          """
              
              # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∫–∞–Ω–∞–ª
              send_url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
              send_params = {
                  "chat_id": CHAT_ID,
                  "text": report,
                  "parse_mode": "Markdown"
              }
              requests.post(send_url, json=send_params)
              print("‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!")
          else:
              print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {response.status_code}")
          PYTHON

