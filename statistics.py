#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
    –°–∏—Å—Ç–µ–º–∞ —Å–±–æ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–æ–≤
    –¥–ª—è Telegram –∫–∞–Ω–∞–ª–∞ @fitnesstimer
    
    –°–æ–±–∏—Ä–∞–µ—Ç:
    - –û—Ç–∑—ã–≤—ã –æ —Ç–∞–π–º–µ—Ä–µ
    - –í–æ–ø—Ä–æ—Å—ã –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö
    - –û–±—â—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç summary –æ—Ç—á—ë—Ç—ã
    - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ email –∏ –≤ Telegram
"""

import json
import os
import requests
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from datetime import datetime, timedelta
from pathlib import Path
from collections import defaultdict

# ============= –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =============

STATISTICS_FILE = Path('.telegram_statistics.json')
TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
ADMIN_EMAIL = 'admin@tabatatimer.ru'
ADMIN_TELEGRAM = '@lobanoff_pro'  # –ò–ª–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å chat_id

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ email (–Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å SMTP)
SMTP_SERVER = os.getenv('SMTP_SERVER', 'smtp.yandex.ru')
SMTP_PORT = int(os.getenv('SMTP_PORT', '465'))
SMTP_USER = os.getenv('SMTP_USER', ADMIN_EMAIL)
SMTP_PASSWORD = os.getenv('SMTP_PASSWORD', '')


def –∑–∞–≥—Ä—É–∑–∏—Ç—å_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ JSON —Ñ–∞–π–ª–∞"""
    if STATISTICS_FILE.exists():
        try:
            with open(STATISTICS_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
    return {
        'total_comments': 0,
        'total_feedback': 0,
        'total_questions': 0,
        'feedback_by_date': {},
        'questions_by_date': {},
        'comments_by_date': {},
        'last_update': None,
        'feedback_list': [],
        'questions_list': []
    }


def —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É(—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ JSON —Ñ–∞–π–ª"""
    try:
        —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['last_update'] = datetime.now().isoformat()
        with open(STATISTICS_FILE, 'w', encoding='utf-8') as f:
            json.dump(—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, f, ensure_ascii=False, indent=2)
        return True
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
        return False


def –¥–æ–±–∞–≤–∏—Ç—å_–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π(–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, —Ç–∏–ø='question'):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    
    Args:
        –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: dict —Å –ø–æ–ª—è–º–∏ 'text', 'from_user', 'username', 'date', 'message_id'
        —Ç–∏–ø: 'feedback' (–æ—Ç–∑—ã–≤ –æ —Ç–∞–π–º–µ—Ä–µ) –∏–ª–∏ 'question' (–≤–æ–ø—Ä–æ—Å –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö)
    """
    —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ = –∑–∞–≥—Ä—É–∑–∏—Ç—å_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É()
    –¥–∞—Ç–∞ = datetime.now().strftime('%Y-%m-%d')
    
    # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['total_comments'] += 1
    if —Ç–∏–ø == 'feedback':
        —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['total_feedback'] += 1
        —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['feedback_list'].append({
            'date': –¥–∞—Ç–∞,
            'timestamp': datetime.now().isoformat(),
            'user': –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.get('from_user', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'),
            'username': –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.get('username', ''),
            'text': –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.get('text', ''),
            'message_id': –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.get('message_id')
        })
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —Å–ø–∏—Å–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 –æ—Ç–∑—ã–≤–æ–≤)
        if len(—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['feedback_list']) > 1000:
            —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['feedback_list'] = —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['feedback_list'][-1000:]
    else:
        —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['total_questions'] += 1
        —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['questions_list'].append({
            'date': –¥–∞—Ç–∞,
            'timestamp': datetime.now().isoformat(),
            'user': –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.get('from_user', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'),
            'username': –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.get('username', ''),
            'text': –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.get('text', ''),
            'message_id': –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.get('message_id')
        })
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —Å–ø–∏—Å–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 –≤–æ–ø—Ä–æ—Å–æ–≤)
        if len(—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['questions_list']) > 1000:
            —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['questions_list'] = —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['questions_list'][-1000:]
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–∞—Ç–∞–º
    if –¥–∞—Ç–∞ not in —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['comments_by_date']:
        —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['comments_by_date'][–¥–∞—Ç–∞] = 0
    —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['comments_by_date'][–¥–∞—Ç–∞] += 1
    
    if —Ç–∏–ø == 'feedback':
        if –¥–∞—Ç–∞ not in —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['feedback_by_date']:
            —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['feedback_by_date'][–¥–∞—Ç–∞] = 0
        —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['feedback_by_date'][–¥–∞—Ç–∞] += 1
    else:
        if –¥–∞—Ç–∞ not in —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['questions_by_date']:
            —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['questions_by_date'][–¥–∞—Ç–∞] = 0
        —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞['questions_by_date'][–¥–∞—Ç–∞] += 1
    
    —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É(—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
    return —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞


def —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å_summary(–ø–µ—Ä–∏–æ–¥_–¥–Ω–µ–π=7):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç summary –æ—Ç—á—ë—Ç –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
    
    Args:
        –ø–µ—Ä–∏–æ–¥_–¥–Ω–µ–π: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 7)
    
    Returns:
        dict —Å summary –¥–∞–Ω–Ω—ã–º–∏
    """
    —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ = –∑–∞–≥—Ä—É–∑–∏—Ç—å_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É()
    –¥–∞—Ç–∞_–Ω–∞—á–∞–ª–∞ = (datetime.now() - timedelta(days=–ø–µ—Ä–∏–æ–¥_–¥–Ω–µ–π)).strftime('%Y-%m-%d')
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–µ—Ä–∏–æ–¥
    –æ—Ç–∑—ã–≤—ã_–∑–∞_–ø–µ—Ä–∏–æ–¥ = [
        f for f in —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.get('feedback_list', [])
        if f.get('date', '') >= –¥–∞—Ç–∞_–Ω–∞—á–∞–ª–∞
    ]
    
    –≤–æ–ø—Ä–æ—Å—ã_–∑–∞_–ø–µ—Ä–∏–æ–¥ = [
        q for q in —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.get('questions_list', [])
        if q.get('date', '') >= –¥–∞—Ç–∞_–Ω–∞—á–∞–ª–∞
    ]
    
    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –¥–∞—Ç–∞–º
    –æ—Ç–∑—ã–≤—ã_–ø–æ_–¥–∞—Ç–∞–º = defaultdict(int)
    –≤–æ–ø—Ä–æ—Å—ã_–ø–æ_–¥–∞—Ç–∞–º = defaultdict(int)
    
    for –æ—Ç–∑—ã–≤ in –æ—Ç–∑—ã–≤—ã_–∑–∞_–ø–µ—Ä–∏–æ–¥:
        –æ—Ç–∑—ã–≤—ã_–ø–æ_–¥–∞—Ç–∞–º[–æ—Ç–∑—ã–≤.get('date', '')] += 1
    
    for –≤–æ–ø—Ä–æ—Å in –≤–æ–ø—Ä–æ—Å—ã_–∑–∞_–ø–µ—Ä–∏–æ–¥:
        –≤–æ–ø—Ä–æ—Å—ã_–ø–æ_–¥–∞—Ç–∞–º[–≤–æ–ø—Ä–æ—Å.get('date', '')] += 1
    
    summary = {
        '–ø–µ—Ä–∏–æ–¥': f'–ü–æ—Å–ª–µ–¥–Ω–∏–µ {–ø–µ—Ä–∏–æ–¥_–¥–Ω–µ–π} –¥–Ω–µ–π',
        '–¥–∞—Ç–∞_–æ—Ç—á—ë—Ç–∞': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
        '–æ–±—â–∞—è_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞': {
            '–≤—Å–µ–≥–æ_–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤': —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.get('total_comments', 0),
            '–≤—Å–µ–≥–æ_–æ—Ç–∑—ã–≤–æ–≤': —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.get('total_feedback', 0),
            '–≤—Å–µ–≥–æ_–≤–æ–ø—Ä–æ—Å–æ–≤': —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.get('total_questions', 0)
        },
        '–∑–∞_–ø–µ—Ä–∏–æ–¥': {
            '–æ—Ç–∑—ã–≤–æ–≤': len(–æ—Ç–∑—ã–≤—ã_–∑–∞_–ø–µ—Ä–∏–æ–¥),
            '–≤–æ–ø—Ä–æ—Å–æ–≤': len(–≤–æ–ø—Ä–æ—Å—ã_–∑–∞_–ø–µ—Ä–∏–æ–¥),
            '–≤—Å–µ–≥–æ_–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏': len(–æ—Ç–∑—ã–≤—ã_–∑–∞_–ø–µ—Ä–∏–æ–¥) + len(–≤–æ–ø—Ä–æ—Å—ã_–∑–∞_–ø–µ—Ä–∏–æ–¥)
        },
        '–æ—Ç–∑—ã–≤—ã_–ø–æ_–¥–∞—Ç–∞–º': dict(–æ—Ç–∑—ã–≤—ã_–ø–æ_–¥–∞—Ç–∞–º),
        '–≤–æ–ø—Ä–æ—Å—ã_–ø–æ_–¥–∞—Ç–∞–º': dict(–≤–æ–ø—Ä–æ—Å—ã_–ø–æ_–¥–∞—Ç–∞–º),
        '–ø–æ—Å–ª–µ–¥–Ω–∏–µ_–æ—Ç–∑—ã–≤—ã': –æ—Ç–∑—ã–≤—ã_–∑–∞_–ø–µ—Ä–∏–æ–¥[-10:],  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –æ—Ç–∑—ã–≤–æ–≤
        '–ø–æ—Å–ª–µ–¥–Ω–∏–µ_–≤–æ–ø—Ä–æ—Å—ã': –≤–æ–ø—Ä–æ—Å—ã_–∑–∞_–ø–µ—Ä–∏–æ–¥[-10:]  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –≤–æ–ø—Ä–æ—Å–æ–≤
    }
    
    return summary


def —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å_summary_–¥–ª—è_—Ç–µ–∫—Å—Ç–∞(summary):
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç summary –≤ —á–∏—Ç–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç"""
    —Ç–µ–∫—Å—Ç = f"""üìä –û–¢–ß–Å–¢ –ü–û –ê–ö–¢–ò–í–ù–û–°–¢–ò TELEGRAM –ö–ê–ù–ê–õ–ê @fitnesstimer

{summary['–ø–µ—Ä–∏–æ–¥']}
–î–∞—Ç–∞ –æ—Ç—á—ë—Ç–∞: {summary['–¥–∞—Ç–∞_–æ—Ç—á—ë—Ç–∞']}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìà –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:
‚Ä¢ –í—Å–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: {summary['–æ–±—â–∞—è_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞']['–≤—Å–µ–≥–æ_–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤']}
‚Ä¢ –í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤ –æ —Ç–∞–π–º–µ—Ä–µ: {summary['–æ–±—â–∞—è_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞']['–≤—Å–µ–≥–æ_–æ—Ç–∑—ã–≤–æ–≤']}
‚Ä¢ –í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö: {summary['–æ–±—â–∞—è_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞']['–≤—Å–µ–≥–æ_–≤–æ–ø—Ä–æ—Å–æ–≤']}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìÖ –ê–ö–¢–ò–í–ù–û–°–¢–¨ –ó–ê –ü–ï–†–ò–û–î:
‚Ä¢ –û—Ç–∑—ã–≤–æ–≤: {summary['–∑–∞_–ø–µ—Ä–∏–æ–¥']['–æ—Ç–∑—ã–≤–æ–≤']}
‚Ä¢ –í–æ–ø—Ä–æ—Å–æ–≤: {summary['–∑–∞_–ø–µ—Ä–∏–æ–¥']['–≤–æ–ø—Ä–æ—Å–æ–≤']}
‚Ä¢ –í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: {summary['–∑–∞_–ø–µ—Ä–∏–æ–¥']['–≤—Å–µ–≥–æ_–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏']}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
"""
    
    # –û—Ç–∑—ã–≤—ã –ø–æ –¥–∞—Ç–∞–º
    if summary['–æ—Ç–∑—ã–≤—ã_–ø–æ_–¥–∞—Ç–∞–º']:
        —Ç–µ–∫—Å—Ç += "\nüìù –û–¢–ó–´–í–´ –ü–û –î–ê–¢–ê–ú:\n"
        for –¥–∞—Ç–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ in sorted(summary['–æ—Ç–∑—ã–≤—ã_–ø–æ_–¥–∞—Ç–∞–º'].items()):
            —Ç–µ–∫—Å—Ç += f"  {–¥–∞—Ç–∞}: {–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ} –æ—Ç–∑—ã–≤(–æ–≤)\n"
    
    # –í–æ–ø—Ä–æ—Å—ã –ø–æ –¥–∞—Ç–∞–º
    if summary['–≤–æ–ø—Ä–æ—Å—ã_–ø–æ_–¥–∞—Ç–∞–º']:
        —Ç–µ–∫—Å—Ç += "\n‚ùì –í–û–ü–†–û–°–´ –ü–û –î–ê–¢–ê–ú:\n"
        for –¥–∞—Ç–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ in sorted(summary['–≤–æ–ø—Ä–æ—Å—ã_–ø–æ_–¥–∞—Ç–∞–º'].items()):
            —Ç–µ–∫—Å—Ç += f"  {–¥–∞—Ç–∞}: {–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ} –≤–æ–ø—Ä–æ—Å(–æ–≤)\n"
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–∑—ã–≤—ã
    if summary['–ø–æ—Å–ª–µ–¥–Ω–∏–µ_–æ—Ç–∑—ã–≤—ã']:
        —Ç–µ–∫—Å—Ç += "\n\nüí¨ –ü–û–°–õ–ï–î–ù–ò–ï –û–¢–ó–´–í–´:\n"
        for idx, –æ—Ç–∑—ã–≤ in enumerate(summary['–ø–æ—Å–ª–µ–¥–Ω–∏–µ_–æ—Ç–∑—ã–≤—ã'], 1):
            —Ç–µ–∫—Å—Ç += f"\n{idx}. {–æ—Ç–∑—ã–≤.get('date', 'N/A')} - {–æ—Ç–∑—ã–≤.get('user', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}\n"
            —Ç–µ–∫—Å—Ç += f"   {–æ—Ç–∑—ã–≤.get('text', '')[:100]}{'...' if len(–æ—Ç–∑—ã–≤.get('text', '')) > 100 else ''}\n"
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤–æ–ø—Ä–æ—Å—ã
    if summary['–ø–æ—Å–ª–µ–¥–Ω–∏–µ_–≤–æ–ø—Ä–æ—Å—ã']:
        —Ç–µ–∫—Å—Ç += "\n\n‚ùì –ü–û–°–õ–ï–î–ù–ò–ï –í–û–ü–†–û–°–´:\n"
        for idx, –≤–æ–ø—Ä–æ—Å in enumerate(summary['–ø–æ—Å–ª–µ–¥–Ω–∏–µ_–≤–æ–ø—Ä–æ—Å—ã'], 1):
            —Ç–µ–∫—Å—Ç += f"\n{idx}. {–≤–æ–ø—Ä–æ—Å.get('date', 'N/A')} - {–≤–æ–ø—Ä–æ—Å.get('user', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}\n"
            —Ç–µ–∫—Å—Ç += f"   {–≤–æ–ø—Ä–æ—Å.get('text', '')[:100]}{'...' if len(–≤–æ–ø—Ä–æ—Å.get('text', '')) > 100 else ''}\n"
    
    —Ç–µ–∫—Å—Ç += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    —Ç–µ–∫—Å—Ç += "üìß –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ñ–∞–π–ª–µ .telegram_statistics.json"
    
    return —Ç–µ–∫—Å—Ç


def –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_–Ω–∞_email(—Ç–µ–∫—Å—Ç, —Ç–µ–º–∞='üìä –û—Ç—á—ë—Ç –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ Telegram –∫–∞–Ω–∞–ª–∞'):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á—ë—Ç –Ω–∞ email"""
    if not SMTP_PASSWORD:
        print("‚ö†Ô∏è SMTP_PASSWORD –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞ email")
        return False
    
    try:
        msg = MIMEMultipart()
        msg['From'] = SMTP_USER
        msg['To'] = ADMIN_EMAIL
        msg['Subject'] = —Ç–µ–º–∞
        
        msg.attach(MIMEText(—Ç–µ–∫—Å—Ç, 'plain', 'utf-8'))
        
        server = smtplib.SMTP_SSL(SMTP_SERVER, SMTP_PORT)
        server.login(SMTP_USER, SMTP_PASSWORD)
        server.send_message(msg)
        server.quit()
        
        print(f"‚úÖ –û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ {ADMIN_EMAIL}")
        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ email: {e}")
        return False


def –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_–≤_telegram(—Ç–µ–∫—Å—Ç, chat_id=None):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á—ë—Ç –≤ –ª–∏—á–Ω—ã–π Telegram
    
    Args:
        —Ç–µ–∫—Å—Ç: —Ç–µ–∫—Å—Ç –æ—Ç—á—ë—Ç–∞
        chat_id: ID —á–∞—Ç–∞ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ADMIN_TELEGRAM)
    """
    if not TELEGRAM_BOT_TOKEN:
        print("‚ö†Ô∏è TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –≤ Telegram")
        return False
    
    try:
        # –ï—Å–ª–∏ chat_id –Ω–µ —É–∫–∞–∑–∞–Ω, –ø—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å username
        if not chat_id:
            # –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ username –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç—å chat_id —á–µ—Ä–µ–∑ getUpdates
            # –ò–ª–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –º–µ—Ç–æ–¥
            # –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤, –µ—Å–ª–∏ chat_id –∏–∑–≤–µ—Å—Ç–µ–Ω
            print("‚ö†Ô∏è chat_id –Ω–µ —É–∫–∞–∑–∞–Ω, –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å ADMIN_TELEGRAM_CHAT_ID")
            return False
        
        url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
        
        # –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏ (–ª–∏–º–∏—Ç Telegram ~4096 —Å–∏–º–≤–æ–ª–æ–≤)
        max_length = 4000
        if len(—Ç–µ–∫—Å—Ç) > max_length:
            —á–∞—Å—Ç–∏ = [—Ç–µ–∫—Å—Ç[i:i+max_length] for i in range(0, len(—Ç–µ–∫—Å—Ç), max_length)]
            for —á–∞—Å—Ç—å in —á–∞—Å—Ç–∏:
                params = {
                    'chat_id': chat_id,
                    'text': —á–∞—Å—Ç—å,
                    'parse_mode': 'HTML'
                }
                response = requests.post(url, json=params, timeout=10)
                if response.status_code != 200:
                    print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: {response.status_code}")
                    return False
        else:
            params = {
                'chat_id': chat_id,
                'text': —Ç–µ–∫—Å—Ç,
                'parse_mode': 'HTML'
            }
            response = requests.post(url, json=params, timeout=10)
            if response.status_code != 200:
                print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: {response.status_code}")
                return False
        
        print(f"‚úÖ –û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram (chat_id: {chat_id})")
        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: {e}")
        return False


def –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_summary(–ø–µ—Ä–∏–æ–¥_–¥–Ω–µ–π=7, –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å_email=True, –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å_telegram=True, telegram_chat_id=None):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç summary –æ—Ç—á—ë—Ç
    
    Args:
        –ø–µ—Ä–∏–æ–¥_–¥–Ω–µ–π: –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å_email: –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ª–∏ –Ω–∞ email
        –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å_telegram: –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ª–∏ –≤ Telegram
        telegram_chat_id: ID —á–∞—Ç–∞ –≤ Telegram (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–∑ env)
    """
    summary = —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å_summary(–ø–µ—Ä–∏–æ–¥_–¥–Ω–µ–π)
    —Ç–µ–∫—Å—Ç = —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å_summary_–¥–ª—è_—Ç–µ–∫—Å—Ç–∞(summary)
    
    if –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å_email:
        –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_–Ω–∞_email(—Ç–µ–∫—Å—Ç)
    
    if –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å_telegram:
        chat_id = telegram_chat_id or os.getenv('ADMIN_TELEGRAM_CHAT_ID')
        if chat_id:
            –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_–≤_telegram(—Ç–µ–∫—Å—Ç, chat_id)
        else:
            print("‚ö†Ô∏è ADMIN_TELEGRAM_CHAT_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –≤ Telegram")
    
    return summary, —Ç–µ–∫—Å—Ç


if __name__ == "__main__":
    # –¢–µ—Å—Ç–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è summary
    summary, —Ç–µ–∫—Å—Ç = –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_summary(–ø–µ—Ä–∏–æ–¥_–¥–Ω–µ–π=7)
    print("\n" + "="*50)
    print(—Ç–µ–∫—Å—Ç)
    print("="*50)

