#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
    –°–∫—Ä–∏–ø—Ç –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–ª–æ–≥–∞
    
    –°–∫–∞—á–∏–≤–∞–µ—Ç –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ blog-posts.json,
    –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Ö –≤ Yandex Cloud –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç URL –≤ JSON.
    
    –ê–≤—Ç–æ—Ä: VR-Lounge
"""

import json
import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –º–æ–¥—É–ª—é –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
sys.path.insert(0, str(Path(__file__).parent))
from image_downloader import —Å–∫–∞—á–∞—Ç—å_–∏_–∑–∞–≥—Ä—É–∑–∏—Ç—å_–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç–∏
SCRIPT_DIR = Path(__file__).parent.absolute()
if (SCRIPT_DIR.parent / 'public_html').exists():
    REPO_ROOT = SCRIPT_DIR.parent
elif (SCRIPT_DIR / 'public_html').exists():
    REPO_ROOT = SCRIPT_DIR
else:
    REPO_ROOT = Path.cwd()
    if not (REPO_ROOT / 'public_html').exists():
        REPO_ROOT = REPO_ROOT.parent

BLOG_POSTS_FILE = REPO_ROOT / 'public_html' / 'blog-posts.json'

def –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å_–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è():
    """–ú–∏–≥—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ blog-posts.json –≤ Yandex Cloud"""
    if not BLOG_POSTS_FILE.exists():
        print("‚ùå –§–∞–π–ª blog-posts.json –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return False
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å—Ç—ã
    with open(BLOG_POSTS_FILE, 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    –ø–æ—Å—Ç—ã = data.get('posts', [])
    print(f"üìù –ù–∞–π–¥–µ–Ω–æ –ø–æ—Å—Ç–æ–≤: {len(–ø–æ—Å—Ç—ã)}")
    
    –æ–±–Ω–æ–≤–ª–µ–Ω–æ = 0
    –æ—à–∏–±–æ–∫ = 0
    
    for –ø–æ—Å—Ç in –ø–æ—Å—Ç—ã:
        post_id = –ø–æ—Å—Ç.get('id', 'unknown')
        –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ_url = –ø–æ—Å—Ç.get('image', '')
        –∑–∞–≥–æ–ª–æ–≤–æ–∫ = –ø–æ—Å—Ç.get('title', '–°—Ç–∞—Ç—å—è')
        
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–∂–µ –∏–∑ Yandex Cloud
        if –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ_url and –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ_url.startswith('https://www.tabatatimer.ru/images/blog/'):
            print(f"‚úÖ –ü–æ—Å—Ç {post_id}: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–∂–µ –≤ Yandex Cloud")
            continue
        
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if not –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ_url:
            print(f"‚ö†Ô∏è –ü–æ—Å—Ç {post_id}: –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
            continue
        
        print(f"\nüì• –ú–∏–≥—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ—Å—Ç–∞: {–∑–∞–≥–æ–ª–æ–≤–æ–∫[:50]}...")
        print(f"   URL: {–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ_url[:80]}...")
        
        # –°–∫–∞—á–∏–≤–∞–µ–º –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        –Ω–æ–≤—ã–π_url = —Å–∫–∞—á–∞—Ç—å_–∏_–∑–∞–≥—Ä—É–∑–∏—Ç—å_–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ(–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ_url, post_id)
        
        if –Ω–æ–≤—ã–π_url and –Ω–æ–≤—ã–π_url != –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ_url:
            –ø–æ—Å—Ç['image'] = –Ω–æ–≤—ã–π_url
            –æ–±–Ω–æ–≤–ª–µ–Ω–æ += 1
            print(f"‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: {–Ω–æ–≤—ã–π_url}")
        else:
            –æ—à–∏–±–æ–∫ += 1
            print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π JSON
    if –æ–±–Ω–æ–≤–ª–µ–Ω–æ > 0:
        with open(BLOG_POSTS_FILE, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
        print(f"\n‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ—Å—Ç–æ–≤: {–æ–±–Ω–æ–≤–ª–µ–Ω–æ}")
        print(f"‚ùå –û—à–∏–±–æ–∫: {–æ—à–∏–±–æ–∫}")
        print(f"üíæ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ {BLOG_POSTS_FILE}")
        return True
    else:
        print(f"\n‚ö†Ô∏è –ù–µ—Ç –ø–æ—Å—Ç–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
        return False

if __name__ == '__main__':
    print("üöÄ –ù–∞—á–∏–Ω–∞—é –º–∏–≥—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–ª–æ–≥–∞...")
    —É—Å–ø–µ—Ö = –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å_–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è()
    if —É—Å–ø–µ—Ö:
        print("\n‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
        print("üìù –¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å—Ç–∏—Ç–µ generate_blog_post_page.py –¥–ª—è –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HTML —Å—Ç—Ä–∞–Ω–∏—Ü")
    else:
        print("\n‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞")
